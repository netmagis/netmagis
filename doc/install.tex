%
% Documentation d'installation de WebDNS
%
%
% Historique
%   2003/11/30 : pda : début de la rédaction
%   2005/04/08 : pda : rédaction de la version 1.3
%   2008/04/11 : pda : rédaction de la version 1.4
%   2010/10/28 : pda : rédaction de la version 1.5
%

\documentclass [twoside] {report}

    \usepackage {epsfig}
    \usepackage {verbatim}
    % \usepackage {makeidx}

    \usepackage [francais] {babel}
    \usepackage [latin9] {inputenc}
    \usepackage [T1] {fontenc}

    \raggedbottom

    \usepackage {mathpazo}		% palatino
    \usepackage [paper=a4paper,margin=22mm] {geometry}

    \NoAutoSpaceBeforeFDP		% pas d'espace automatique avant ":"

    \frenchspacing
    \parskip=5mm
    \parindent=0mm
    \renewcommand {\arraystretch} {1.4}

    \usepackage {supertabular}

    % \pagestyle {headings}

    \usepackage [dvips] {changebar}

    \parskip=2mm

    %
    % Les particularités liées à l'utilisation de latex2html
    %
    \usepackage {html}

    \begin {htmlonly}
	\renewcommand {\cbstart} {}
	\renewcommand {\cbend} {}
	\renewcommand {\cbdelete} {}

	% texte noir sur fond blanc, liens non parcourus en rouge
	% \bodytext {TEXT="#000000" BGCOLOR="#ffffff" LINK="#ff0000"}
	% texte noir sur fond blanc
	\bodytext {TEXT="#000000" BGCOLOR="#ffffff"}
    \end {htmlonly}

    % \newcommand {\htmlurl} [1] {#1}

    \newcommand {\titreANN} [1] {\cleardoublepage\chapter* {#1}
	    \addcontentsline {toc} {chapter} {#1}}
    \newcommand {\titreA} [1] {\cleardoublepage\chapter {#1}}
    \newcommand {\titreAN} [1] {\chapter {#1}}
    \newcommand {\titreB} [1] {\section {#1}}
    \newcommand {\titreC} [1] {\subsection {#1}}
    \newcommand {\titreD} [1] {\subsubsection {#1}}
    \newcommand {\titreE} [1] {\paragraph {#1}}

    \newcommand {\fichier} [1] {\texttt{#1}\xspace}

    \newcommand {\slashslash} {\char92\char92}

    \newcommand {\figpswidth} [2] {
	\begin {center}
	    \epsfig {figure=#1.ps,width=#2}
	\end {center}
    }

\begin {document}

    \title {\Huge\bf Application WebDNS \\ Installation et configuration}
    \author {\bf Pierre David, Jean Benoit}
    % \date {Version 1.2 -- 12 avril 2004}
    % \date {Version 1.3 -- 13 avril 2005}
    % \date {Version 1.4 -- 13 avril 2008}
    \date {Version 1.5 -- xx novembre 2010}

\maketitle

\rm

\thispagestyle {empty}
    \begin {quote}
	La composition de ce document a été effectuée par un
	ordinateur avec le système d'exploitation Unix (plus
	spécifiquement FreeBSD, une version libre), en utilisant
	le logiciel de composition \TeX\ (logiciel libre). Les
	figures ont été dessinées sous X-Window (logiciel libre) avec
	le logiciel {\tt xfig} (logiciel libre) et intégrées
	directement dans le document final.
	La version HTML a été générée avec \latextohtml{} (logiciel
	libre).

	\cbstart%1.5
	L'ensemble de l'application WebDNS, ainsi que ce document,
	est sous licence CeCILL-B (voir annexe~\ref {licence}).
	\cbend%1.5

	La dernière version de ce document est accessible à l'adresse : \\
	\hspace* {10mm}
	\htmlurl {http://webdns.u-strasbg.fr/}
    \end {quote}

    \vspace {160mm}
%    \latex {\vspace {160mm}}
%    \html {\htmlrule}

%    \begin {quote}
%	\em Toute reproduction, même partielle, de ce
%	document est interdite. Une copie ou reproduction
%	par quelque procédé que ce soit, photographie,
%	photocopie, microfilm, bande magnétique, disque ou
%	autre, constitue une contrefaçon passible par la loi
%	du 11 mars 1957 sur la protection des droits
%	d'auteur.
%    \end {quote}

    \begin {center}
	Version 1.5, xx novembre 2010 \\
	\copyright
	    Université de Strasbourg, Pierre David et Jean Benoit,
	    2004-2010
    \end {center}
%\end {titlepage}
\setcounter {page} {0}


{
    \setlength {\parskip} {0cm}         % pour avoir un sommaire "tassé"
    \cleardoublepage
    \tableofcontents
    % \listoffigures
    % \listoftables
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Introduction
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\titreA {Introduction}
    \label {liste-diff}

L'application WebDNS a été présentée\footnote {\htmlurl
{http://2003.jres.org/actes/paper.144.pdf}} pour la première fois
aux JRES 2003 à Lille. Depuis, elle a suscité un intérêt qui a
motivé les auteurs à rentrer dans une logique de diffusion pour la
communauté.

L'objectif premier de WebDNS était de déléguer la gestion du DNS à
un public de «~correspondants réseau~» sur un réseau, qu'il soit
de laboratoire, de campus, métropolitain, etc.

Par la suite, de nouvelles fonctionnalités sont apparues~: gestion
des rôles de messagerie, permettant une gestion fine et décentralisée
du routage de messagerie sur un campus, et plus récemment intégration
des informations liées au protocole DHCP. WebDNS constitue, de ce
fait, la brique de base d'un système d'information orienté vers la
gestion du réseau, concept qui a été développé lors d'une
présentation\footnote {\htmlurl {http://2005.jres.org/paper/82.pdf}}
aux JRES 2005 à Marseille.
\cbstart%1.5
La disponibilité de WebDNS a également constitué un facilitateur
pour migrer l'architecture de messagerie d'un campus vers
SMTP-Authentifié comme cela a été présenté dans un article\footnote
{\htmlurl {http://2009.jres.org/planning_files/article/pdf/124.pdf}}
aux JRES 2009 à Nantes.
\cbend%1.5

Jusqu'en 2002, le réseau métropolitain strasbourgeois Osiris\footnote
{\htmlurl {http://www-crc.u-strasbg.fr/osiris}} fonctionnait sans
délégation~: pour toute modification, les correspondants faisaient
appel au service réseau qui saisissait manuellement les informations.
Parmi les caractéristiques du réseau Osiris, on trouve une cinquantaine
de zones, dont une (\texttt {u-strasbg.fr}) regroupe à l'heure
actuelle plus de 25$\thinspace$000 noms, ainsi qu'une population
d'environ une centaine de correspondants réseau appartenant à une
quinzaine d'établissements différents.  Souhaitant offrir à ces
correspondants davantage d'indépendance tout en leur apportant un
meilleur service, les auteurs se sont donc attelés à la rédaction
de WebDNS et l'application a été ouverte en juin 2002.

Ce document décrit en détail l'installation de l'application, ainsi
que certains éléments du paramétrage. Une bonne connaissance du DNS,
du système Unix et de la configuration d'un serveur Web est
requise.

\vspace* {10mm}

La dernière version de ce document est disponible sur \htmlurl
{http://webdns.u-strasbg.fr}.

La liste de diffusion \texttt {webdns@u-strasbg.fr} est ouverte à
tous les utilisateurs de l'application WebDNS. Pour s'y abonner,
il suffit d'envoyer un message à \texttt {sympa@u-strasbg.fr}
avec «~\verb|SUBSCRIBE webdns|~» dans le corps du message.
Les archives sont consultables sur
\htmlurl {http://listes.u-strasbg.fr/}.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Principes
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\titreA {Principes}

\titreB {Objectifs}

L'application WebDNS est une application permettant de gérer une
ou plusieurs zones DNS, et d'en déléguer tout ou partie à une
population d'utilisateurs (les correspondants réseaux) par un
mécanisme de droits fin.

Plus précisément, l'application WebDNS permet de gérer des informations
associées à un parc de machines, comme le nom, l'adresse IP, l'adresse
MAC (ou adresse Ethernet), mais également le type de système
d'exploitation, la personne responsable ou un commentaire à usage
général.

Le système de droits permet de déléguer l'administration d'un
sous-réseau (ou une partie de sous-réseau, à l'adresse IP près si
l'administrateur le souhaite) et d'un domaine à une ou plusieurs
personnes, réunies dans un ou plusieurs groupes.

Certaines des informations sont rendues publiques via le DNS, comme
l'association entre un nom et une adresse IP, mais également les
adresses DNS reconnues comme des adresses de messagerie valides.

D'autres informations, comme l'association entre adresses MAC et
adresses IP peuvent être utilisées par un serveur DHCP, pour réaliser
une l'allocation statique. Des mécanismes permettent également
d'associer des profils particuliers (comme les options nécessaires
au \textit {boot} d'une station sans disque ou d'un terminal X par
exemple) à des machines, voire d'allouer des intervalles d'allocation
dynamiques pour accueillir des portables.

D'autres informations, enfin, sont destinées à un usage interne,
comme par exemple le nom et l'adresse électronique de la personne
responsable de la machine.


Au delà de ces applications particulières, l'application WebDNS
constitue le c{\oe}ur d'un système complet de gestion d'un réseau
universitaire (qu'il soit de laboratoire, de campus, métropolitain
ou régional).


\titreB {Les constituants de l'application WebDNS}

L'application WebDNS est une application multitiers. Son principe
de fonctionnement est résumé sur la figure ci-après, qui illustre plus
particulièrement l'aspect de la génération de zones DNS~:

\figpswidth {multitiers} {140mm}

On peut voir sur cette figure que l'utilisateur accède à ses données
par l'intermédiaire de son navigateur Web, via le protocole HTTPS.
Le \textbf {serveur Web} (typiquement Apache) ne fait que mettre
en forme des données, qui elles-mêmes stockées sur le \textbf
{serveur de données}.  Le serveur de données abrite la base de
données PostgreSQL, et le serveur Web communique avec le serveur
de données par l'intermédiaire du protocole PostgreSQL.

Le serveur DNS (typiquement Bind) récupère périodiquement (via
\texttt {cron}) les informations qui ont changé dans la base de
données, via là encore le protocole PostgreSQL, et les stocke dans
les fichiers de zone classiques. Le fichier \texttt {named.conf}
de Bind, quant à lui, est constitué par l'administrateur du système
et n'est pas généré par l'application.


Le même schéma s'applique également pour la génération de la
configuration DHCP sur un serveur central (où le serveur DHCP,
typiquement le serveur d'ISC, est client PostgreSQL du serveur de
données), ou pour la génération de la table de routage de messagerie
(où le serveur de messagerie est également client PostgreSQL du
serveur de données).

Enfin, l'authentification à l'application est réalisée par le serveur
Web à partir d'une base externe (typiquement une base PostgreSQL
ou un annuaire LDAP). L'authentification LDAP est conçue pour
s'adapter à des environnements divers, mais complexes et disposant
de leur propre gestion (annuaire d'établissement ou d'entreprise).
Pour les cas plus simples, une application est fournie dans la
distribution de WebDNS pour gérer les utilisateurs avec une base
PostgreSQL.  Voir la section~\ref {auth} (page~\pageref {auth})
pour plus d'informations.


\titreB {Fonctionnalités}

\titreC {Génération de zones DNS}

L'intérêt premier de l'application WebDNS est de faciliter la
génération de zones DNS, toujours cohérentes (plus d'incompatibilités
entre zone normale et zone inverse, numéro de SOA toujours à jour,
etc.).

Le passage par une application Web, avec les mécanismes de verrouillage
associés à un moteur de bases de données relationnel sérieux, permet
à plusieurs personnes d'éditer la configuration simultanément.

L'application permet d'associer des informations complémentaires
(nom et adresse électronique du responsable de la machine, commentaire)
pour faciliter la gestion du parc.


\titreC {Routage de messagerie}

La configuration de l'application permet également de gérer les
aspects liés au routage de la messagerie~:

\begin {itemize}
    \item soit en affectant, pour une zone donnée, des champs DNS
	(resource records) supplémentaires indiquant les MX associés
	à chaque machine~;

    \item soit en laissant aux correspondants réseaux, pour une
	zone donnée, la possibilité de spécifier les machines aptes
	à recevoir du courrier~; ceci suppose la configuration des
	relais de messagerie (MX) pour une zonne donnée~;

\end {itemize}

\cbstart%1.5
\titreC {Gestion de SMTP authentifié}
    \label {pres-droitsmtp}

WebDNS est également utile pour permettre l'utilisation de SMTP
authentifié. Plus exactement, WebDNS peut gérer les exceptions à
la règle de filtrage du port SMTP non authentifié.

En effet, la migration de tout un domaine à SMTP authentifié
nécessite~:

\begin {itemize}
    \item la mise à jour de l'ensemble du parc de clients SMTP
	(sur les serveurs, mais également sur les postes clients)~;

    \item la mise à jour de l'ensemble du parc de serveurs SMTP
	pour interdire les connexions non authentifiées (sauf en
	provenance du ou des relayeurs de messagerie du domaine)~;

    \item une politique de filtrage interdisant les connexions SMTP
	non authentifiées.

\end {itemize}

Une solution simple pour distinguer les connexions SMTP authentifiées
des connexions non authentifiées consiste à n'utiliser le port SMTP
standard (port TCP 25) que pour SMTP non authentifié, et le port
587 (ou 465 pour tenir compte des limitations de certaines versions
du client Outlook) pour SMTP authentifié. Avec cette politique, il
est facile d'interdire le port 25 :

\begin {itemize}
    \item entre réseaux, sauf vers les relayeurs centraux.

    \item sur les relayeurs centraux, depuis toute machine qui
	n'héberge pas de boîtes aux lettres~;

\end {itemize}

Malgré tout le soin apporté à la mise à jour de l'ensemble du parc,
il reste toujours quelques machines ne pouvant pas utiliser SMTP
authentifié. Il s'agit par exemple de systèmes embarqués
(photocopieurs-scanneurs ou autres machines spécialisées), voire
de serveurs (ou d'administrateurs système) obsolètes.

Pour gérer ces exceptions, WebDNS permet d'attribuer à des groupes
de correspondants un droit spécifique~: celui-ci leur permet de
déclarer une machine comme ayant le droit d'émettre en SMTP non
authentifié. L'attribut correspondant peut ensuite être utilisé pour
alimenter une table de filtres IP sur le relayeur de messagerie.

Pour plus d'information sur la migration vers un service SMTP
authentifié, le lecteur intéressé est invité à se référer à
l'article\footnote {\htmlurl
{http://2009.jres.org/planning_files/article/pdf/124.pdf}} présenté
aux JRES 2009.
\cbend%1.5


\titreC {Utilisation de DHCP}

Les fonctionnalités offertes par WebDNS en matière de gestion DHCP
sont~:

\begin {itemize}
    \item l'association statique d'une adresse MAC à un nom (et une
	adresse IP)~;
	\cbdelete%1.5

    \item la déclaration d'intervalles d'adresses IP réservés pour
	l'allocation dynamique~; il est possible de déclarer des
	noms pour les adresses IP de l'intervalle (ex: \texttt
	{dhcp01}, \texttt {dhcp02}, etc.), mais pas d'adresse MAC~:
	l'allocation dynamique est en effet incompatible avec
	l'allocation statique.

\end {itemize}

\cbstart%1.5
À chaque association DHCP (statique ou dynamique) est associé
éventuellement un «~profil DHCP~», c'est à dire un ensemble d'options
de configuration du serveur DHCP communes à plusieurs machines
(comme par exemple l'adresse du serveur de \textit {boot} d'un PC
sans disque)~;
\cbend%1.5

Ces fonctionnalités sont offertes réseau par réseau (dans l'application,
mais également sur les routeurs concernés) et groupe de correspondant
par groupe de correspondant.


\titreB {Authentification}
    \label {auth}

\titreC {Principes}

Comme toute application manipulant des données critiques, les accès
à l'application WebDNS sont basés sur une authentification préalable.

Cette authentification à l'application est réalisée par le serveur
Web.  Elle repose sur une base d'authentification externe à
l'application. La figure suivante illustre le principe~:

\figpswidth {auth} {140mm}

Sur cette figure sont représentées les deux bases. La première est
la base PostgreSQL pour WebDNS. Celle-ci ne contient d'autre
information sur les utilisateurs que leur login.

La deuxième base est dédiée à l'authentification. Elle peut s'appuyer
sur un serveur PostgreSQL ou un annuaire LDAP\footnote {Le support
d'autres types de base se fait par ajout du code correspondant dans
le fichier \texttt {pkgtcl/webapp.tcl}.}. Elle contient quatre types
d'informations pour chaque utilisateur~:

\begin {itemize}
    \item le login
    \item les informations relatives au nom de l'utilisateur, à
	son adresse, etc. que WebDNS pourra utiliser, par exemple,
	pour trouver le correspondant en charge d'un réseau
    \item les informations d'authentification (mot de passe chiffré)
    \item les informations d'autorisation (pour donner les droits
	d'accès à une partie spécifique du serveur Web)

\end {itemize}

Cette base est externe à WebDNS pour permettre l'intégration facile
de l'application dans des environnements structurés autour d'un
annuaire d'établissement existant, le plus souvent basé sur le
protocole LDAP. Les opérations sur la base d'authentification se
font alors via le système d'information existant dans l'organisation.
Dès lors, WebDNS se contente d'un login pour représenter l'utilisateur,
déterminer ses droits par l'intermédiaire de son enregistrement
dans un groupe (notion spécifique à l'application WebDNS), et
permettre l'accès aux objets gérés par l'application.


\titreC {WebAuth}
    \label {sec:intro-webauth}

Dans les environnements où un annuaire centralisé n'est pas déjà
disponible, l'application WebAuth (voir~\ref {install-webauth},
page~\pageref {install-webauth}) est également fournie\footnote
{Disponible dans la distribution de WebDNS~: répertoire \texttt
{pgauth/}} pour gérer la base d'authentification dans une base
PostgreSQL.

Les opérations que WebAuth permet de réaliser sont~:

\begin {itemize}
    \item changement du mot de passe (pour tous les utilisateurs)
    \item ajout, modification ou suppression des comptes utilisateurs
    \item gestion de groupe pour définir les domaines gérés par le
	serveur Web

\end {itemize}


\titreC {Authentification}

L'authentification à l'application (que ce soit pour WebDNS ou
WebAuth) est donc réalisée par le serveur Web, qui communique ensuite
le login de l'utilisateur aux scripts CGI.

Les systèmes de validation de l'authentification sont spécifiques
au serveur Web utilisé. On peut néanmoins citer pour Apache~:

\begin {itemize}
    \item \verb|mod_ldap|
    \item \verb|mod_pgsql|
\end {itemize}

Vous pouvez également utiliser le module CAS (\verb|mod_auth_cas|)
pour Apache pour offrir du «~Single Sign On~» à vos utilisateurs.
Si les auteurs n'ont pas encore la pratique de ce module, et ne
peuvent fournir d'assistance, plusieurs utilisateurs en revanche
ont indiqué sur la liste de diffusion Webdns (voir chapitre~\ref
{liste-diff}, page~\pageref {liste-diff}) qu'ils avaient pratiqué
cette authentification.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%}}
% Structure de la distribution
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\titreA {Structure de la distribution}

La distribution de l'application WebDNS est organisée comme suit~:

\begin {tabular} {|l|l|} \hline
    \texttt {doc/}
	& documentation (y compris ce document)
	\\ \hline
    \texttt {dump/}
	& répertoire de sauvegarde quotidienne de la base
	\\ \hline
    \texttt {expl/}
	& scripts de maintenance et d'exploitation de la base
	\\ \hline
    \texttt {htg/}
	& générateur de pages Web
	\\ \hline
    \texttt {inst/}
	& scripts d'installation et de chargement initial de la base
	\\ \hline
    \texttt {pkgtcl/}
	& paquetages Tcl utilisés par les divers scripts
	\\ \hline
    \texttt {upgrade/}
	& scripts de migration de la base...
	\\ \hline
    \texttt {upgrade/12-13/}
	& ... de la version 1.2 vers la version 1.3
	\\ \hline
    \texttt {upgrade/13-14/}
	& ... de la version 1.3 vers la version 1.4
	\\ \hline
    \cbstart%1.5
    \texttt {upgrade/14-15/}
	& ... de la version 1.4 vers la version 1.5
	\cbend%1.5
	\\ \hline
    \texttt {www/}
	& application WebDNS
	\\ \hline
    \texttt {www/bin/}
	& les scripts CGI de WebDNS
	\\ \hline
    \texttt {www/lib/}
	& fichiers utilisés par les scripts, y compris les pages HTML
	    à trous
	\\ \hline
    \texttt {www/lib/util/}
	& utilitaires non liés au Web, mais placés ici pour
	    profiter du Makefile
	\\ \hline
    \texttt {pgauth/}
	& application WebAuth pour l'authentification PostgreSQL
	\\ \hline
    \texttt {pgauth/expl/}
	& scripts de maintenance de WebAuth
	\\ \hline
    \texttt {pgauth/expl/}
	& scripts d'installation de WebAuth
	\\ \hline
    \texttt {pgauth/www/}
	& arborescence Web de Webauth
	\\ \hline
    \texttt {pgauth/www/bin/}
	& les scripts CGI de WebAuth
	\\ \hline
    \texttt {pgauth/www/lib/}
	& fichiers utilisés par les scripts, y compris les pages HTML
	    à trous
	\\ \hline
\end {tabular}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%}}
% Pré-requis
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\titreA {Pré-requis}

Cette section décrit les pré-requis avant d'entamer l'installation.

\titreB {Composants nécessaires}

Les composants logiciels nécessaires pour l'application WebDNS sont
décrits ci-après. Certains prérequis sont spécifiques à un type
d'authentification (PostgreSQL ou LDAP), il n'y a donc pas lieu de
les installer si vous n'utilisez pas le type d'authentification
correspondant.


\titreC {Apache}

Le premier composant indispensable est un serveur Web.  En théorie,
tout serveur Web disposant d'une interface CGI est utilisable. En
pratique, l'application a été testée avec Apache (versions 1 et 2).
Par ailleurs, il est impératif d'utiliser une extension SSL pour
bénéficier d'un bon niveau de sécurité.

Disponibilité~: \htmlurl {http://httpd.apache.org/}

\titreC {Tcl}

Le langage utilisé par l'application et nombre de scripts auxiliaires
est le langage Tcl (Tool Control Language) développé à l'origine par
John Ousterhout. WebDNS a été développé avec la version
\cbstart%1.5
8.5.
\cbend%1.5

Il faut noter que Tcl est souvent associé à la boîte à outils
graphique Tk.  Cette dernière n'est pas utilisée par WebDNS.
Cependant, il est possible que la compilation de PostgreSQL (voir
ci-après) nécessite Tk.

Disponibilité~: \htmlurl {http://tcl.activestate.com/}


\titreC {Tcllib}

La bibliothèque de fonctions Tcllib permet d'utiliser l'extension
objet «~Snit~» et d'accéder éventuellement à un annuaire LDAP. Soyez
sûr d'utiliser une version 1.10 ou supérieure.

Disponibilité~: \htmlurl {http://www.tcl.tk/software/tcllib/}


\titreC {PostgreSQL}

Le moteur de base de données utilisé est PostgreSQL. Il faut utiliser
une version supérieure ou égale à
\cbstart%1.5
8.3.
\cbend%1.5


Disponibilité~: \htmlurl {http://www.postgresql.org/}

Attention~: la compilation de PostgreSQL doit être réalisée avec
le support du langage «~PL/Tcl~» dans le moteur. 
Sous FreeBSD, cela signifie qu'il faut charger le port de \texttt
{postgresql-pltcl}. Pour tester si cela fonctionne, utilisez la
commande \texttt {createlang} fournie avec PostgreSQL~:

\begin {quote}
\small
\begin {verbatim}
$ createlang pltcl
\end{verbatim}
\end {quote}

Si vous rencontrez une erreur, le support de PL/Tcl n'est pas
correctement installé.


\cbstart%1.5
\titreC {Pgtclng}

Le support de PostgreSQL pour les applications rédigées avec Tcl
nécessite le paquet pgtclng, dans une version supérieure ou égale
à 1.6.

Pour vérifier si ce paquet est bien installé, faire~:

\begin {quote}
\small
\begin {verbatim}
$ tclsh8.5      # ou "tclsh" simplement
% package require Pgtcl
1.6.2
\end{verbatim}
\end {quote}

Si vous rencontrez une erreur à la place d'un numéro de version (ici
1.6.2), le support Tcl pour PostgreSQL n'est pas correctement installé.

Disponibilité~: \htmlurl {http://pgtclng.projects.postgresql.org/}
\cbend%1.5

\titreC {mod\_auth\_pgsql (authentification PostgreSQL)}
    \label {mod-auth-pgsql}

L'authentification des utilisateurs dans l'application est réalisée
par le serveur Apache. Pour le moment, la seule authentification
définie repose sur une base PostgreSQL, ainsi que sur le module
\texttt {mod\_auth\_pgsql}.

Disponibilité~: \htmlurl {http://www.giuseppetanzilli.it/mod\_auth\_pgsql/}
    (pour Apache 1)

Disponibilité~: \htmlurl {http://www.giuseppetanzilli.it/mod\_auth\_pgsql2/}
    (pour Apache 2)

\titreC {mod\_auth\_ldap (authentification LDAP)}

Ce module étant déjà inclus dans la distribution du serveur Apache
(version $\geq$ 2), il est cité ici pour mémoire.


\titreC {OpenSSL (authentification PostgreSQL)}
    \label {openssl}

Lorsqu'un utilisateur souhaite changer son mot de passe, avec
l'authentification PostgreSQL et l'application WebAuth (voir \ref
{sec:intro-webauth}, \pageref {sec:intro-webauth}), la commande
\texttt {openssl} permet de chiffrer le nouveau mot de passe avant
de l'insérer dans la base.

Le logiciel Openssl est fourni avec la quasi-totalité des Unix
distribués actuellement.

Disponibilité~: \htmlurl {http://www.openssl.org/}


\titreC {pwgen (authentification PostgreSQL)}
    \label {pwgen}

Le programme \texttt {pwgen} permet de générer des mots de passe.

Disponibilité~: \htmlurl {http://sourceforge.net/projects/pwgen/}

\titreC {LaTeX}
    \label {latex}

Pour accéder aux impressions (génération de fichiers PDF), il faut
également une distribution LaTeX contenant au moins le programme
\texttt {pdflatex} ainsi que les paquetages
    \texttt {babel},
    \texttt {fontenc},
    \texttt {palatino},
    \texttt {geometry}, et
    \texttt {supertabular}.

Tout ceci figure soit dans la distribution teTeX (obsolète), soit
dans la distribution TeXLive.

Disponibilité~: \htmlurl {http://www.tug.org/texlive/}

Si vous ne souhaitez pas installer LaTeX, vous ne pourrez pas accéder
aux impressions. Nous vous conseillons alors de modifier les pages
Web pour ne pas afficher les boutons correspondants.


\titreB {Contexte système}

\titreC {Activer les mots de passe PostgreSQL}

À moins que votre serveur Web ne soit hébergé sur une machine sans
compte utilisateur (autre que les administrateurs), il est souhaitable
de configurer PostgreSQL pour que les connexions au moteur nécessitent
un mot de passe.

Pour cela, il faut éditer le fichier \texttt {\~{}pgsql/data/pg\_hba.conf}
installé avec PostgreSQL, et modifier les lignes~:
\begin {quote}
\small
\begin {verbatim}
local all all                           trust
host  all all 127.0.0.1 255.255.255.255 trust
host  all all ::1       ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff trust
\end{verbatim}
\end {quote}
en~:
\begin {quote}
\small
\begin {verbatim}
local all all                           password
host  all all 127.0.0.1 255.255.255.255 password
host  all all ::1       ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff password
\end{verbatim}
\end {quote}

Il faut également modifier certains des scripts de démarrage, et
attribuer des mots de passe aux utilisateurs déjà créés à l'aide
de l'utilitaire \texttt {psql} et de la directive SQL «~\texttt
{ALTER...USER}~». Par exemple~:

\begin {quote}
    \verb|ALTER USER pda WITH PASSWORD 'toto' ;|
\end {quote}

Consultez \htmlurl
{http://www.postgresql.org/docs/current/static/client-authentication.html}
pour plus d'informations.

Vous pouvez néanmoins procéder au reste de l'installation sans
activer la protection par mot de passe, au prix d'une sécurité
amoindrie.


\titreC {Utilisateurs PostgreSQL}

Il est conseillé de créer des comptes PostgreSQL (avec l'utilitaire
\texttt {createuser}) pour les utilisateurs pouvant intervenir lors
des opérations d'administration de la base (hors applications Web).
La création de comptes spécifiques simplifie les opérations.

En outre, les divers scripts et exemples de configuration nécessitent
la création d'un utilisateur PostgreSQL nommé «~\texttt {dns}~»,
avec le minimum de droits (en particulier, pas le droit de créer
une base ou de nouveaux utilisateurs).  Toutes les opérations
d'authentification ainsi que les opérations effectuées par l'application
le seront sous cette identité.  Il n'y a pas besoin de créer un
compte Unix pour \texttt {dns}.

Une fois créés, vous pouvez affecter des mots de passe à ces
utilisateurs.


\titreC {Accès à PostgreSQL depuis le serveur Apache}

Si vous localisez le serveur Apache et le serveur PostgreSQL sur
des machines différentes, prenez bien soin de configurer le serveur
PostgreSQL pour accepter les connexions depuis le serveur Apache.
PostgreSQL. Pour cela, modifiez le fichier \texttt {pg\_hba.conf}
et insérez la ligne suivante~:

\begin {quote}
\small
\begin {verbatim}
host dns dns 192.168.1.2 255.255.255.255 password
\end{verbatim}
\end {quote}

Cette ligne autorise l'accès à la base «~\texttt {dns}~» par
l'utilisateur «~\texttt {dns}~» depuis la machine d'adresse IPv4
192.168.1.2. Bien sûr, si l'accès se fait par IPv6, vous remplacerez
l'adresse et le masque par les valeurs appropriées.

L'application WebAuth (pour l'authentification PostgreSQL) utilise
en outre l'utilisateur «~\texttt {auth}~» pour accéder à la base
«~\texttt {auth}~». Comme précédemment, il n'y a pas besoin de
créer un compte Unix pour cet utilisateur.


\titreC {Accès à PostgreSQL depuis les autres serveurs}
    \label {acces-pgsql}

La conception de WebDNS et WebAuth vous permet de séparer les
diverses fonctions sur des serveurs physiquement différents~:

\begin {itemize}
    \item le serveur Web~;
    \item le serveur DNS~;
    \item le relais de messagerie, si vous utilisez les «~rôles de
	messagerie~» (voir~\ref {anx-rolemail}, page~\pageref
	{anx-rolemail})
    \item
	le serveur DHCP.
\end {itemize}

Il faut donc configurer le serveur PostgreSQL pour autoriser l'accès
depuis ces différents serveurs. Pour cela, modifiez le fichier
\texttt {\~{}pgsql/data/pg\_hba.conf} pour y insérer des lignes de
la forme~:

\begin {quote}
\small
\begin {verbatim}
host dns dns 192.168.1.2 255.255.255.255 password
\end{verbatim}
\end {quote}

Cette ligne autorise l'accès à la base \texttt {dns} par l'utilisateur
\texttt {dns} depuis la machine d'adresse IPv4 192.168.1.2. Bien
sûr, si l'accès se fait par IPv6, vous remplacerez l'adresse et le
masque par les valeurs appropriées.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%}}
% Personnalisation des pages HTML
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\titreA {Personnalisation des pages HTML et LaTeX}

Parmi les possibilités de personnalisation de l'application WebDNS
figure en bonne place la faculté de modifier les pages HTML et LaTeX
de l'application.

En effet, la présentation est largement indépendante de la logique
des scripts, et repose des «~templates~», appelés «~pages à trous~»
dans la suite de ce document.


\titreB {Principe des «~pages à trous~»}

Lorsqu'un script CGI souhaite afficher une information, il la place
dans un fond de page HTML à un endroit déterminé par un «~trou~»,
matérialisé par une chaîne de la forme \verb|%nom%|.

Par exemple, une page servant à confirmer l'enregistrement d'une
demande pourrait se limiter à~:

\begin {quote}
\small
\begin {verbatim}
<HTML>
<TITLE>Demande enregistrée</TITLE>
<BODY>
    <H1>Demande enregistrée</H1>
    <STRONG>%MESSAGE%</STRONG>
    <P>
    <A HREF="%HOMEURL%">Revenir au menu principal</A>
</BODY>
</HTML>
\end{verbatim}
\end {quote}

Cette page contient deux trous~: à la place du premier,
«~\verb|%MESSAGE%|~», les scripts de l'application insèrent le
contenu du message de confirmation. À la place du second,
«~\verb|%HOMEURL%|~», les scripts insèrent l'adresse Web de
l'application.

Ce principe s'applique également aux fichiers LaTeX utilisés pour
générer les fichiers PDF, lors des demandes d'impression.

L'annexe~\ref {anx-trous} décrit les fichiers HTML et les trous que
les scripts CGI de l'application utilisent.


\titreB {Utilisation du générateur «~htg~»}
    \label {htg:principe}

\cbstart%1.5
Les pages HTML sont générées automatiquement à partir d'un mini-langage
(HTG, pour HTML Generator). L'outil HTG, qui permet de transformer
un source HTG en fichier HTML, est fourni (répertoire \verb|./htg|)
ainsi que sa documentation (répertoire \verb|./htg/doc|).

L'intérêt de l'utilisation de HTG est de dissocier complètement le
fond de la forme. L'utilisateur de HTG ne spécifie que le fond, et HTG
s'occupe de la forme par le biais de \textit {modèles}. Quatre types de
modèles sont fournis~:

\begin {itemize}
    \item
	modèle «~webdns~»~: inspiré du modèle «~crc~» ci-après sans
	les spécificités locales, et utilisé pour le site \htmlurl
	{http://webdns.u-strasbg.fr}.

    \item modèle «~crc~»~: utilisé autrefois au Centre Réseau
	Communication de l'Université Louis Pasteur de Strasbourg~;

    \item modèle «~csi~»~: utilisé autrefois au Centre de Services
	Informatiques de l'Université de
	Versailles/St-Quentin-en-Yvelines~;

    \item modèle «~vide~»~: utilisé comme exemple, avec le minimum de
	fioritures d'affichage.

\end {itemize}

\cbend%1.5

\titreB {Quelles pages HTML utiliser~?}

Plusieurs solutions s'offrent à vous~:

\begin {itemize}
    \item utiliser HTG~: dans ce cas, il vous suffit de reprendre les
	pages actuelles, en les modifiant éventuellement pour
	indiquer des titres plus représentatifs de votre service.

	Concernant le choix du modèle, vous pouvez alors~:
	\begin {itemize}
	    \item reprendre le modèle «~webdns~»~;
	    \item concevoir un nouveau modèle (cette option
		n'est pas documentée ici) en vous inspirant
		des modèles existants.
	\end {itemize}

    \item utiliser des fonds de page HTML que vous aurez conçus
	vous-même.
\end {itemize}


\cbstart%1.5
\titreB {Installation du générateur «~htg~»}
    \label {htg-webdns}

Pour compiler «~\texttt {htg}~», allez dans le répertoire
\verb|./htg/src|, éditez le fichier \texttt {Makefile} et lancez
la compilation avec \texttt {make}.

Ensuite, sélectionnez le type de modèle que vous préférez en changeant
le lien \verb|./htg/modeles/default|\footnote {Si vous démarrez,
nous vous conseillons de choisir le modèle «~webdns~».}.

Installez maintenant l'ensemble dans le répertoire de votre
choix\footnote {Il n'y a pas de contrainte par rapport à ce répertoire.
Il peut être (et il vaut mieux qu'il soit) situé à l'extérieur de
l'arborescence Web servie par votre serveur Apache.}.  Pour cela,
allez dans le répertoire \verb|./htg|, éditez le fichier \texttt
{Makefile}, modifiez la variable \verb|DESTDIR| et lancez l'installation
avec \texttt {make}.

Enfin, si vous utilisez le modèle «~crc~» ou «~webdns~», vous devez
recopier (ou rendre accessible en utilisant un lien symbolique) le
contenu du répertoire \verb|./htg/modeles/default/css| (ou sa version
installée), y compris le sous-répertoire \texttt {images}, dans le
répertoire \texttt {/css} de votre arborescence Web.

\cbend%1.5

%%%%% XXX manque une étape de vérification


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%}}
% Installation des paquetages Tcl
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\titreA {Installation des paquetages Tcl}
    \label {install-pkgtcl}

L'application inclut des paquetages Tcl rédigés afin de simplifier
l'écriture d'applications. Ce chapitre décrit l'installation de ces
paquetages.

\titreB {Choix du répertoire d'installation}

Tous les paquetages décrits ici doivent être installés dans un seul
et même répertoire, dont le chemin sera indiqué lors de l'installation
de l'application (variable \texttt {PKGTCL} des fichiers \texttt
{Makefile}). Vous êtes donc libre de les installer où vous le
souhaitez, voire même de les laisser dans le répertoire à partir
duquel vous avez détarré les sources.
\cbdelete%1.5


\titreB {Modification des paquetages}

Les paquetages doivent éventuellement être modifiés pour tenir
compte de la configuration de votre système, des chemins, etc. Les
sections suivantes donnent l'ensemble des modifications nécessaires.

\titreC {Modification du paquetage \texttt {webapp}}

Modifiez les lignes du fichier \texttt {./pktcl/webapp.tcl}~:

\begin {quote}
\small
\begin {verbatim}
    variable pdflatex   /usr/local/bin/pdflatex
    variable sendmail   {/usr/sbin/sendmail -t}
\end{verbatim}
\end {quote}

pour refléter la localisation des commandes~:

\begin {itemize}
    \item \texttt {pdflatex} (voir~\ref {latex}, page~\pageref {latex})
    \item \texttt {sendmail}, utilisé pour envoyer un mail lorsqu'un mot
	de passe est réinitialisé (si vous utilisez l'authentification
	PostgreSQL)
\end {itemize}


\titreC {Modification du paquetage \texttt {arrgen}}

Aucune modification n'est nécessaire.

\titreC {Modification du paquetage \texttt {pgsql}}

Aucune modification n'est nécessaire.

\titreC {Modification du paquetage \texttt {auth}}

Si vous devez utiliser l'application WebAuth (et seulement dans ce
cas là) pour utiliser l'authentification PostgreSQL, vous devez
modifier les deux lignes du fichier \texttt {./pktcl/auth.tcl}~:

\begin {quote}
\small
\begin {verbatim}
    variable trpw       "/usr/bin/openssl passwd -1"
    variable genpw      "/usr/local/bin/pwgen --numerals 8 1"
\end{verbatim}
\end {quote}

pour refléter la localisation des commandes~:

\begin {itemize}
    \item \texttt {openssl}, pour chiffrer un mot de passe
	(voir~\ref {openssl}, page~\pageref {openssl})
    \item \texttt {pwgen}, pour générer un nouveau mot de passe
	(voir~\ref {pwgen}, page~\pageref {pwgen})
\end {itemize}


\cbstart%1.5
\titreB {Installation des paquetages}

Modifiez le fichier \texttt {Makefile} pour refléter le nom et la
version de l'exécutable \texttt {tclsh}.

Tapez ensuite \texttt {make} dans le répertoire courant pour générer
le fichier \texttt {pkgIndex.tcl}.

Si vous avez décidé d'installer les paquetages dans un autre
répertoire, copiez tout les fichiers (y compris \texttt {pkgIndex.tcl})
vers cet autre répertoire.

\cbend%1.5

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%}}
% Installation de l'application WebAuth
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\titreA {Installation de l'application WebAuth}
    \label {install-webauth}

L'application WebAuth (voir~\ref {sec:intro-webauth}, page~\pageref
{sec:intro-webauth}) n'est utile que si vous n'avez pas déjà un
système d'annuaire centralisé de vos utilisateurs (comme un annuaire
LDAP d'établissement, par exemple). Si c'est le cas, ce chapitre
explique comment installer un système d'authentification reposant
sur une base PostgreSQL.

Si vous utilisez un annuaire LDAP, passez directement au chapitre
suivant.

Hormis le paramétrage du serveur Apache, vous n'avez pas besoin des
droits de «~\texttt {root}~» pour effectuer les opérations décrites
dans ce chapitre.

\titreB {Introduction}

L'application WebAuth a initialement été conçue comme un moyen de
gérer une base d'authentification utilisée par des applications
Web. Parmi ses fonctionnalités figurait la possibilité d'adjoindre
à n'importe quelle application Web une interface de gestion des
utilisateurs, grâce à seulement quelques lignes de code.

\begin {itemize}
    \item
	avec le développement de l'authentification basée sur des
	annuaires LDAP, une telle application est devenue progressivement
	inutile pour la plupart des organisations ayant adopté
	WebDNS, voire même un frein dans la mesure où cela nécessitait
	une double saisie des utilisateurs (une fois avec LDAP et
	une fois avec WebAuth)~;

    \item
	les autres applications développées au CRC n'ont pas connu
	une diffusion telle que WebAuth puisse être utilisée dans
	d'autres contextes.

\end {itemize}

Il est donc devenu clair que WebDNS devait s'affranchir de la gestion
des utilisateurs. Pour les organisations qui n'ont pas mis en place
un annuaire LDAP, WebAuth est dorénavant fourni avec WebDNS, et
continue de fournir un mode d'authentification basé sur une base
PostgreSQL.

WebAuth gère des utilisateurs et des groupes. Les utilisateurs sont
identifiés par un «~login~», possèdent un mot de passe pour
l'authentification et possèdent également des coordonnées (adresse,
mail, téléphone, etc.).

WebAuth ne traite pas directement l'authentification aux applications~:
les utilisateurs étant stockés dans une base PostgreSQL, un module
auxiliaire (voir~\ref {mod-auth-pgsql}, page~\pageref {mod-auth-pgsql})
permet à Apache de valider l'authentification d'un utilisateur à
WebDNS et à WebAuth.

Par ailleurs, un utilisateur participe à un ou plusieurs groupes.
Les groupes ont pour but de délimiter des «~espaces Web~» (voir~\ref
{grp-webauth}, page~\pageref {grp-webauth}), c'est à dire des
portions de l'arborescence Web. Attention~: ces groupes ne doivent
pas être confondus avec ceux de WebDNS, qui servent à définir des
droits sur des adresses IP, des réseaux, des domaines, etc.

Typiquement, un seul groupe WebAuth est nécessaire pour délimiter
tous les utilisateurs de WebDNS. Un autre groupe WebAuth (groupe
«~\texttt {authadmin}~») est requis pour identifier les utilisateurs
de WebAuth ayant le droit de gérer les utilisateurs.

Vous pouvez utiliser le principe de WebAuth pour vos propres besoins,
et ainsi délimiter d'autres espaces Web (intranet de populations
délimitées, tels que des correspondants réseau par exemple). Le
fait qu'un utilisateur puisse être dans plusieurs groupes vous
permet dès lors une très grande souplesse.


\titreB {Installation de la base PostgreSQL}

Cette section décrit la mise en place minimale de la base de données
utilisée comme support de l'application WebAuth. Il s'agit de créer la
base et d'y introduire le minimum d'informations nécessaire pour
pouvoir effectuer le paramétrage dans le menu d'administration.

\titreC {Création de la base}

Examinez le script \texttt {./pgauth/inst/creer-base}. Dans ce script~:

\begin {itemize}
    \item modifiez votre mot de passe PostgreSQL~;

    \item mettez en commentaire la ligne «~\verb|exit 0|~» située
	vers le début du fichier. Lorsque vous aurez exécuté le
	script, supprimez ce \verb|#| ce qui vous protégera ainsi
	d'une maladresse si vite arrivée~!

    \item modifiez les logins des utilisateurs privilégiés. Ces
	utilisateurs (PostgreSQL) doivent pouvoir réaliser toutes les
	opérations dans la base. Pour cela, tous les droits sont donnés
	aux tables de l'application.

\end {itemize}

Vous pouvez à présent exécuter le script (après avoir changé de
répertoire dans \texttt {./pgauth/inst}).

Pour vérifier si tout s'est bien passé, vous pouvez utiliser
«~\verb|psql|~» pour passer les deux commandes \verb|\dt| (afficher
les tables) et \verb|\q| (sortir)~:

\begin {quote}
\small
\begin {verbatim}
$ psql auth
auth=# \dt
     List of relations
 Schema |     Name     | Type  | Owner
--------+--------------+-------+-------
 public | config       | table | pda
 public | groupes      | table | pda
 public | membres      | table | pda
 public | utilisateurs | table | pda
(4 rows)

auth=# \q
\end{verbatim}
\end {quote}


\titreC {Installation des données minimales}

Le script \texttt {./pgauth/inst/init-base} contient le minimum, c'est à
dire l'insertion d'un groupe (\texttt {authadmin}) et d'un utilisateur
dans ce groupe.

Dans ce script~:

\begin {itemize}
    \item modifiez le login, le mot de passe, le nom et le prénom
	par vos coordonnées. Il s'agit ici d'insérer le minimum
	pour pouvoir ajouter les autres utilisateur par l'application
	Web.  Le mot de passe doit être chiffré~: reprenez par
	exemple celui qui est dans votre fichier \texttt {/etc/passwd}
	ou équivalent.  Si vous laissez le mot de passe par défaut,
	pensez à le changer le plus rapidement possible lorsque
	l'application sera opérationnelle.

    \item modifiez également la ligne affectant votre nom de login
	au groupe \texttt {authadmin}.

    \item mettez en commentaire la ligne «~\verb|exit 0|~» située
	vers le début du fichier. Lorsque vous aurez exécuté le
	script, supprimez ce \verb|#| ce qui vous protégera ainsi
	d'une maladresse si vite arrivée~!

\end {itemize}

Lancez le script.

Pour vérifier si l'installation s'est bien passée, vous pouvez
utiliser «~\verb|psql|~» pour consulter ce qui a été mis dans la
base~:

\begin {quote}
\small
\begin {verbatim}
$ psql auth
auth=# \encoding latin9

auth=# SELECT * FROM groupes ;
  groupe   |              descr
-----------+---------------------------------
 authadmin | Administrateurs de la base Auth
(1 row)

auth=# SELECT login, password, nom, prenom, phnom, phprenom FROM utilisateurs ;
 login |   password   |  nom  | prenom | phnom | phprenom
-------+--------------+-------+--------+-------+----------
 pda   | xxxxxxxxxxxx | DAVID | Pierre | D930  | P600
(1 row)

auth=# SELECT * FROM membres ;
 login |  groupe
-------+-----------
 pda   | authadmin
(1 row)

auth=# \q
\end{verbatim}
\end {quote}

Vous pouvez constater que les colonnes \texttt {phnom} et \texttt
{phprenom} ont été mises à jour automatiquement~: elles contiennent
une chaîne représentant la forme phonétique du nom et du prénom,
ce qui permettra ultérieurement des recherches par approximation.

\titreC {Regénération de votre mot de passe}

Si vous perdez votre mot de passe, vous pouvez le regénérer simplement
avec la commande \texttt {psql}~:

\begin {quote}
\small
\begin {verbatim}
$ psql auth
auth=# UPDATE utilisateurs SET password = 'xxxx' WHERE login = 'pda' ;
UPDATE 1

auth=# \q
\end{verbatim}
\end {quote}

Dans cet exemple, la chaîne «~\texttt {xxxx}~» représente le mot
de passe chiffré tel qu'il figure dans le fichier \texttt
{/etc/master.passwd} ou équivalent.


\titreB {Installation des fichiers de l'application WebAuth}

Choisissez un répertoire pour placer les pages Web et les scripts
CGI de l'application de gestion des utilisateurs, qui ne doit pas
être le répertoire dans lequel vous avez détarré l'application.
Dans l'installation par défaut, ce répertoire est nommé
\verb|/local/services/www/applis/auth/|.

\begin {itemize}
    \item si vous souhaitez utiliser HTG (voir~\ref {htg:principe},
	page~\pageref {htg:principe}), utilisez les fichiers
	«~\verb|.htgt|~» situés dans le répertoire \verb|./pgauth/www/lib/|
	en modifiant éventuellement les parties «~bannière~»,
	«~titrepage~» et «~bandeau~»~;

    \item si vous souhaitez concevoir des nouvelles pages à trous,
	installez-les dans \verb|./pgauth/www/lib/|. Vous
	devrez supprimer chaque fichier «~.htgt~» et le remplacer
	par un fichier «~.html~» équivalent, en respectant le nom
	des trous que les scripts CGI s'attendent à trouver (voir
	annexe~\ref {anx-trous}). Vous prendrez soin également
	d'adapter le fichier LaTeX \verb|utiliste.tex|.

\end {itemize}

Rendez-vous ensuite dans le répertoire \verb|./pgauth/www| et éditez le
fichier \texttt {Makefile}. Modifiez en particulier les variables~:

\begin {tabular} {|l|l|} \hline
    \multicolumn {1} {|c|} {\textbf {Variable}}
	& \multicolumn {1} {|c|} {\textbf {Signification}}
	\\ \hline
    \texttt {TCLSH} &
	localisation de l'exécutable \texttt {tclsh}
	\\ \hline
    \texttt {AUTH} &
	paramètres d'accès à la base d'authentification
	\\ \hline
    \texttt {HOMEURL} &
	chemin relatif à la racine de l'arborescence Web
	\\ \hline
    \texttt {DESTDIR} &
	localisation de l'application dans l'arborescence Web
	\\ \hline
    \texttt {PKGTCL} &
	localisation des packages Tcl inclus avec l'application
	\\ \hline
    \texttt {HTG} &
	localisation de l'exécutable \texttt {htg}
	\\ \hline
    \texttt {ROOT} &
	utilisateurs habilités à intervenir en mode
	«~maintenance~»
	\\ \hline
    \texttt {NOLOGIN} &
	nom du fichier à créer pour rentrer en mode
	«~maintenance~»
	\\ \hline
\end {tabular}

Puis, lancez \texttt {make} (dans le répertoire \verb|./pgauth/www|)
pour installer tous les fichiers de l'application dans l'arborescence
Web.


\titreB {Configuration du serveur Apache}
    \label {config-apache-auth}

Le serveur Apache doit être configuré pour~:

\begin {itemize}
    \item autoriser l'accès en consultation à
	\verb|/local/services/www/applis/auth/|
    \item autoriser l'accès en exécution CGI à
	\verb|/local/services/www/applis/auth/bin|
    \item interdire tout accès à
	\verb|/local/services/www/applis/auth/lib|
\end {itemize}


Ceci peut être réalisé grâce aux quelques lignes suivantes (voir
\verb|./pgauth/inst/httpd.conf|) dans la partie «~https~» du fichier
\texttt {httpd.conf} de configuration d'Apache, que vous prendrez
soin d'adapter~:

\begin {quote}
    \small
    \verbatiminput {../pgauth/inst/httpd.conf}
\end {quote}

Ces lignes font également référence à la directive \texttt
{ErrorDocument} pour renvoyer une page d'erreur appropriée en cas
d'échec d'authentification~; si vous n'avez pas une telle page, qui
doit forcément être externe à l'application, supprimez la ligne.

Il est également fait référence à un fichier d'inclusion \texttt
{auth-pgsql.conf} (voir \verb|./inst/httpd.conf|, situé dans le
répertoire WebDNS et non de WebAuth) que vous prendrez également
soin d'adapter~:
    \label {auth-pgsql.conf}

\begin {quote}
    \small
    \verbatiminput {../inst/auth-pgsql.conf}
\end {quote}


\titreB {Paramétrage de l'application}

Une fois les étapes précédentes effectuées, vous devriez être en mesure
d'accéder à l'URL de votre application.

\titreC {Paramètres de configuration}

La première étape consiste à rentrer dans le module «~administration~»
(modification des paramètres) afin de finaliser les paramétrages.

L'aide en ligne intégrée (lien correspondant à chaque paramètre)
fournit des exemples que vous pouvez facilement adapter.

\titreC {Configuration des groupes et des utilisateurs}
    \label {grp-webauth}

Un groupe WebAuth correspond à un ensemble de pages Web accessibles
sur votre serveur Web. En ce sens, la notion de groupe correspond
à un «~domaine Web~»\footnote {Tant que le nom du «~royaume
d'authentification, correspondant à la directive Apache «~\texttt
{AuthName}~», est le même, l'utilisateur n'aura pas à re-saisir son
mot de passe.}.

Ceci permet d'avoir des applications différentes sur le serveur
Web, dont l'accès est contrôlé par la simple appartenance à un
groupe dans la base PostgreSQL.

Avant de créer un groupe, il faut donc réfléchir au périmètre auquel
les utilisateurs de ce groupe auront accès.

Le premier groupe, «~\texttt {authadmin}~», créé lors de l'étape
précédente d'installation des données minimales correspond aux
utilisateurs ayant droit à gérer les utilisateurs grâce à l'application
WebAuth, et donc à gérer les comptes.

\titreC {Création du groupe pour WebDNS}

Il faut maintenant créer un deuxième groupe dans la base
d'authentification pour les utilisateurs de l'application WebDNS.
Par exemple, les correspondants du réseau métropolitain strasbourgeois
«~Osiris~» sont regroupés dans le groupe «~\texttt {osiris}~».

Ceci est réalisé soit au moyen de l'application WebAuth (menu
«~Groupes/Ajouter~»). Ensuite, il faudra y ajouter les utilisateurs,
soit par l'application (menu «~Utilisateurs/Ajouter~»), soit par
l'écriture d'un script comparable à celui fourni pour le remplissage
initial (voir fichier \texttt {./pgauth/inst/init-base}).  N'oubliez
pas de vous ajouter dans ce deuxième groupe (par l'intermédiaire
du menu «~Groupes/Modifier~» par exemple).

Le groupe choisi devra être spécifié dans la configuration Apache
d'accès à l'application WebDNS (voir~\ref {config-apache}, page~\pageref
{config-apache}), ainsi que dans l'application elle-même (voir plus
bas, \ref {remplir-config}, page~\pageref {remplir-config}) pour
la création de nouveaux correspondants.


\titreB {Script auxiliaire de maintenance de la base}

L'application WebAuth est complétée par un script auxiliaire, lancé
par \texttt {cron} pour réaliser les opérations de maintenance et
de sauvegarde de la base PostgreSQL. Ce script, \verb|./pgauth/expl/quotidien|,
effectue une sauvegarde dans le répertoire \texttt {./dump}, ainsi
qu'un «~\texttt {VACUUM}~» (spécifique PostgreSQL) sur la base.

De plus, il permet également de créer une copie de la base
d'exploitation dans une base de développement, mais ceci n'est pas
activé par défaut.

Après l'avoir modifié selon vos besoins, vous pouvez le lancer
toutes les nuits par \texttt {cron}, de préférence avant minuit
pour avoir des noms de fichiers de sauvegarde représentatifs du
jour sauvegardé.  Voici, pour exemple, une ligne de \texttt {crontab}
possible (voir fichier \texttt {./pgauth/expl/crontab.auth})~:

\begin {quote}
\small
\begin {verbatim}
30 22 * * * $HOME/expl/quotidien
\end{verbatim}
\end {quote}


\titreB {Groupes WebAuth et groupes WebDNS}

Dans la suite de ce document, il sera fait mention de groupes dans
le contexte de WebDNS. Ces groupes correspondent à des droits de
l'application WebDNS (droits sur les adresses IP, sur les domaines,
etc.) et ne doivent absolument pas être confondus avec les groupes
WebAuth, dont le but est de restreindre l'accès à certaines parties
de l'arborescence Web.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%}}
% Installation de la base PostgreSQL
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\titreA {Installation et chargement de la base PostgreSQL de WebDNS}

Ce chapitre décrit la mise en place de la base de données.

Il est vraisemblable que vous ne faites pas une installation ex-nihilo
de l'application WebDNS, mais que vous cherchez à intégrer un
existant, sous forme de zones DNS, de listes de réseaux et de
correspondants.  Cette section est donc consacrée au chargement
initial de la base en reprenant votre existant.

Il est très conseillé de lire attentivement le modèle des données
(voir annexe~\ref {anx-mcd}, page~\pageref {anx-mcd}) ainsi que
l'annexe~\ref {parametrage} (voir page~\pageref {parametrage}) sur
le paramétrage de l'application WebDNS. Ces deux annexes décrivent
en détail les principaux concepts utilisés dans la suite.

La reprise d'un existant, parfois chargé d'histoire, représente un
défi majeur. L'insertion des données dans une base, avec les
contraintes que cela représente, nécessite un effort important de
rationalisation dont vous n'avez pas forcément conscience à ce
stade. C'est pour cela que les opérations de reprise de l'existant
sont effectuées par des scripts que vous pouvez «~rejouer~» autant
de fois que vous le souhaitez. En tout état de cause, ne vous
découragez pas~: le résultat en vaut la peine\footnote {Sinon, vous
ne liriez pas cette documentation, n'est-ce pas~?}.


\titreB {Vérification de vos zones}

L'étape indispensable, avant d'aller plus loin, consiste à vous
assurer que vos zones sont correctes. Deux outils sont essentiels
pour cela~:

\begin {itemize}
    \item les fichiers de journalisation de votre serveur DNS~;

    \item l'utilitaire ZoneCheck\footnote {\htmlurl
	{http://www.afnic.fr/outils/zonecheck}} de l'AFNIC.

\end {itemize}

Si, si, regardez encore. Vraiment. C'est indispensable.


\titreB {Création de la base}

Examinez le script \texttt {./inst/creer-base}. Dans ce script~:

\begin {itemize}
    \item modifiez votre mot de passe PostgreSQL~;

    \item mettez en commentaire la ligne «~\verb|exit 0|~» située
	vers le début du fichier. Lorsque vous aurez exécuté le
	script, remettez le \verb|#| qui vous protégera ainsi d'une
	maladresse si vite arrivée~!

    \item modifiez les logins des utilisateurs privilégiés. Ces
	utilisateurs (PostgreSQL) doivent pouvoir réaliser toutes les
	opérations dans la base. Pour cela, tous les droits sont donnés
	aux tables de l'application.

\end {itemize}

Après avoir changé votre répertoire courant pour \texttt {./inst},
vous pouvez à présent exécuter le script.

Pour vérifier si tout s'est bien passé, vous pouvez utiliser
«~\verb|psql|~» pour passer les deux commandes \verb|\dt| (afficher
les tables) et \verb|\q| (sortir)~:


\begin {quote}
\small
\begin {verbatim}
$ psql dns dns
dns=# \dt
           List of relations
 Schema |     Name      | Type  | Owner
--------+---------------+-------+-------
 public | communaute    | table | pda
 public | config        | table | pda
 public | corresp       | table | pda
 public | dhcp          | table | pda
 public | dhcpprofil    | table | pda
 public | dhcprange     | table | pda
 public | domaine       | table | pda
 public | dr_dhcpprofil | table | pda
 public | dr_dom        | table | pda
 public | dr_ip         | table | pda
 public | dr_mbox       | table | pda
 public | dr_reseau     | table | pda
 public | etablissement | table | pda
 public | groupe        | table | pda
 public | hinfo         | table | pda
 public | log           | table | pda
 public | relais_dom    | table | pda
 public | reseau        | table | pda
 public | role_mail     | table | pda
 public | role_web      | table | pda
 public | rr            | table | pda
 public | rr_cname      | table | pda
 public | rr_ip         | table | pda
 public | rr_mx         | table | pda
 public | zone          | table | pda
 public | zone_normale  | table | pda
 public | zone_reverse4 | table | pda
 public | zone_reverse6 | table | pda
(28 rows)

dns=# \q
\end{verbatim}
\end {quote}


\titreB {Chargement initial des données}

Tous les scripts d'initialisation et de chargement sont situés dans le
sous-répertoire \texttt {./inst}.

Les fichiers de configuration fournis en exemple décrivent un réseau
fictif. Le premier objectif est de fournir un exemple complet et
représentatif. Le deuxième objectif est de vous permettre de tester
rapidement l'application WebDNS sur des données imaginaires, avant
de procéder au chargement de vos données.


\titreC {Script \texttt {init-base}}

Le script \texttt {init-base} est normalement le seul que vous
lancerez directement. Il enchaîne toutes les actions individuelles,
qui sont schématisées dans le tableau ci-après~:

{
    \small
    \begin {tabular} {|l|p{65mm}|p{20mm}|p{20mm}|} \hline
	\multicolumn {1} {|c|} {\textbf {Script}}
	    & \multicolumn {1} {|c|} {\textbf {Action}}
	    & \multicolumn {1} {|c|} {\textbf {Tables concernées}}
	    & \multicolumn {1} {|c|} {\textbf {Fichiers en entrée}}
	    \\ \hline
	\texttt {remplir-config}
	    & Initialise les tables de configuration du
		référentiel
	    & \texttt {config},
		\texttt {hinfo}
	    & (aucun)
	    \\ \hline
	\texttt {remplir-grpnet}
	    & Charge les réseaux, crée les correspondants (qui sont
		censés pré-exister dans la base d'authentification,
		qu'elle soit PostgreSQL ou LDAP), crée les groupes
		WebDNS et leur affecte les réseaux et les adresses
		IP autorisées.
	    &
		\texttt {communaute},
		\texttt {corresp},
		\texttt {dr\_ip},
		\texttt {etablissement},
		\texttt {groupe},
		\texttt {dr\_reseau},
		\texttt {reseau}
	    &
		\texttt {subnet.txt}
		\texttt {group.txt}
	    \\ \hline
	\texttt {charger-domaines}
	    & Enchaîne les appels au script \texttt {remplir-domaine}
		pour chacun des domaines gérés, dans le bon ordre.
	    & cf ci-dessous
	    & (aucun)
	    \\ \hline
	\texttt {remplir-domaine}
	    & Explore un fichier de zone pour remplir la base avec
		tous les RR de type A, AAAA ou CNAME trouvés après
		le prologue.
	    &
		\texttt {domaine},
		\texttt {rr},
		\texttt {rr\_cname},
		\texttt {rr\_ip}
	    & fichier de zone
	    \\ \hline
	\texttt {remplir-grpdom}
	    & Initialise les domaines accessibles par chaque
		correspondant
	    &
		\texttt {domaine},
		\texttt {dr\_dom}
	    & \texttt {grpdom.txt}
	    \\ \hline
	\texttt {remplir-rolemail}
	    & Associe un hébergeur à toutes les adresses de messagerie
		déclarées, initialise les relais associés aux domaines
		et ajoute les droits correspondants aux groupes.
	    &
		\texttt {dr\_dom},
		\texttt {role\_mail},
		\texttt {rr}
	    & \texttt {rolemail.txt}, \texttt {relaisdom.txt}
	    \\ \hline
	\texttt {charger-zones}
	    & Enchaîne les appels au script \texttt {remplir-zone}
		pour chacune des zones DNS.
	    & cf ci-dessous
	    & (aucun)
	    \\ \hline
	\texttt {remplir-zone}
	    & Remplit les paramètres de génération d'une zone, dont le
		prologue, extrait du fichier de zone.
	    &
		\texttt {zone\_normale},
		\texttt {zone\_reverse4},
		\texttt {zone\_reverse6}
	    & fichier de zone, \texttt {rrsup.txt}
	    \\ \hline
	\texttt {remplir-triggers}
	    & Crée les \textit {triggers} et les fonctions PL/SQL qui
		seront appelés pour marquer une zone comme étant «~à
		générer~» lorsqu'un nom ou une adresse IP est
		modifiée.
	    & (aucune)
	    & (aucun)
	    \\ \hline
    \end {tabular}
}

Le lecteur attentif constatera que toutes les tables de la base ne
sont pas modifiées par ces scripts.
En effet, les tables non citées ne sont pas indispensables pour
la reprise d'un existant, et n'ont donc pas été intégrées dans les
scripts de chargement initial.

Normalement, le script n'est censé être appelé qu'une seule fois,
au chargement initial. Cependant, il est très vraisemblable que vos
données devront être modifiées à la lumière des premières incohérences
détectées par les scripts, ou lors des tests de l'application. Vous
pouvez bien sûr recréer la base (script \texttt {creer-base}) et
refaire le chargement (script \texttt {init-base}) autant de fois
que vous le désirez.

Les scripts \texttt {remplir-domaine} et \texttt {remplir-zone}
utilisent tous deux vos fichiers de zones existants, tels qu'ils
sont utilisés par votre serveur DNS. Vous allez devoir séparer
deux parties dans chaque fichier~: le prologue, et la liste des RR.
Pour cela, il vous suffit d'insérer un commentaire (voir la description
des scripts) à l'endroit de la coupure. Ainsi, les fichiers consultés
pour le chargement peuvent directement être les fichiers que vous
exploitez sur le serveur DNS. Ceci peut s'avérer intéressant si
le chargement initial prend plus de temps que prévu et si vous
voulez continuer à ajouter ou supprimer des machines sur le serveur
DNS pendant toute la durée de l'opération.

Enfin, tous les scripts (de la forme \texttt {remplir-}*) doivent
être modifiés pour référencer l'interprète Tcl et fournir le mot
de passe que vous aurez choisi pour accéder à la base. Le script
\texttt {substituer} pourrait bien vous être d'un grand secours
pour automatiser ces modifications.


\titreC {Script \texttt {remplir-config}}
    \label {remplir-config}

Ce script est le plus simple de tous. Il remplit les deux tables
\texttt {config} (paramètres de l'application) et \texttt {hinfo}
(types de machines reconnues).

Hormis le mot de passe (variable \texttt {PGPASSWORD}), il faut
modifier la liste des groupes WebAuth qui peuvent accéder à
l'application. Cette dernière information n'est utilisée que lorsque
vous procéderez à la création d'un compte pour un correspondant.


\titreC {Script \texttt {remplir-grpnet}}

Ce script est sans doute un des plus complexes. Il crée~:

\begin {itemize}
    \item les établissements et les communautés, à partir
	de valeurs dans le script lui-même~;

    \item les groupes et les correspondants, à partir d'un fichier
	\texttt {group.txt}, contenant, sur chaque ligne, le nom
	d'un groupe suivi par le ou les logins des correspondants
	rattachés à ce groupe.

	Par exemple~:

	\begin {quote}
	\small
\begin {verbatim}
sysadm pda jean
lma    marcel
\end{verbatim}
	\end {quote}

	Dans cet exemple, le groupe WebDNS \texttt {sysadm} est
	créé, rassemblant les correspondants de logins \texttt {pda}
	et \texttt {jean}. Les correspondants sont supposés avoir
	déjà été créés dans la base WebAuth.

	Attention~: la notion de groupe WebDNS (autorisation de
	modification d'un domaine et d'une plage d'adresses IP) ne
	doit pas être confondue avec la notion de groupe WebAuth
	(autorisation d'accès à une portion de l'arborescence Web).

    \item les réseaux à partir d'un fichier \texttt {subnet.txt}
	contenant des entrées de la forme~:

	\begin {quote}
	\small
\begin {verbatim}
nom=LMA
subnet=172.16.11.0
netmask=255.255.255.0
gateway=172.16.11.254
communaute=Recherche
etablissement=UM
localisation=Campus 1 - Batiment bidule
groupes=lma
\end{verbatim}
	\end {quote}

	Note~: ce script ne gère pour le moment que des adresses
	IPv4.  Le portage pour charger un réseau IPv6 existant n'est
	pas encore effectué\footnote {Rassurez-vous, le script de
	chargement des machines, \texttt {remplir-domaine}, sait
	traiter les RR de type AAAA contenant des adresses IPv6.}.
	Si vous devez introduire un réseau IPv6 existant, faites-le
	après le chargement initial, avec l'interface Web.

    \item les droits sur les plages d'adresses IP. Pour tout réseau
	défini dans le fichier \texttt {subnet.txt}, l'accès est
	donné aux membres du groupe à l'ensemble des adresses du
	réseau, en retirant les droits sur l'adresse de \textit
	{broadcast} et sur l'adresse du routeur par défaut si elle
	est indiquée.

	Certains groupes doivent avoir accès à tous les réseaux,
	comme par exemple les membres d'un service gérant l'ensemble
	du réseau. Il n'est pas conseillé d'indiquer ces groupes
	dans tous les réseaux listés dans \texttt {subnet.txt}, car
	sinon les droits seraient retirés sur les adresses particulières
	(\textit {broadcast} et routeur par défaut)~; il vaut mieux
	introduire, après le chargement initial, des droits d'accès
	agrégés pour l'ensemble des réseaux gérés.  Par exemple,
	le réseau «~Osiris~» étant constitué d'réseau de classe~B, le
	groupe des administrateurs n'est pas listé dans les réseaux
	individuellement décrits dans \texttt {subnet.txt}, mais
	le droit «~allow 130.79/16~» a été ajouté a posteriori
	grâce au menu de \textit {modification des caractéristiques
	d'un groupe}.

\end {itemize}

Le script \texttt {remplir-grpnet} doit être modifié pour~:

\begin {itemize}
    \item le chemin de l'interprète Tcl~;
    \item le mot de passe d'accès à la base DNS~;
    \item la liste des établissements (en laissant la chaîne «~\texttt
	{INCONNU}~» en fin de liste)~;
    \item la liste des communautés (en laissant la chaîne «~\texttt
	{INCONNUE}~» en fin de liste)~;
    \item la liste des groupes ayant l'autorisation de paramétrer
	l'application (il n'y aura vraisemblablement qu'un seul
	groupe, le vôtre).
\end {itemize}


\titreC {Scripts \texttt {charger-domaines} et \texttt {remplir-domaine}}

Le script \texttt {remplir-domaine} analyse un fichier de zone et
charge dans la base les RR de type A, AAAA ou CNAME qui se trouvent
après le prologue. Les RR de type MX sont ignorés. Les autres types
de RR sont également ignorés, mais ils sont signalés par un message.

Tous les RR créés le sont avec un nom de login de correspondant.
Sur Osiris, nous avons chargé tous les RR avec un login d'un
correspondant fictif. Ceci nous permet de déterminer facilement les
RR issus du chargement initial, par opposition aux RR ajoutés depuis.

La fin du prologue est déterminée par la recherche d'une expression
régulière dans le fichier de zone. Cette expression est, par défaut~:

\begin {quote}
    \verb|^; COUPER ICI|
\end {quote}

En insérant cette ligne (qui est un commentaire, le \verb|^| désigne
le début de la ligne) dans vos fichiers de zone, vous pouvez aisément
délimiter la fin du prologue sans perturber l'exploitation du serveur
DNS pendant que vous mettez au point le chargement de la base.

Attention~: les RR doivent avoir une syntaxe valide pour le nom en
partie gauche. En particulier, le nom ne doit comporter aucun point.
Un problème souvent rencontré est la tentative de chargement d'un
RR de type «~\verb|www.truc IN CNAME www.univ-machin.fr|~»~: la
partie gauche n'est pas valide puisque \texttt {www.truc} n'est pas
un nom valide. Si vous rencontrez ce cas, vous avez deux solutions~:
soit créer une nouvelle zone pour \texttt {truc.univ-machin.fr},
soit déplacer le RR fautif dans le prologue, auquel cas il devient
une exception gérée manuellement avec tous les risques d'incohérence
ultérieure que cela comporte.

Les RR de type CNAME sont ajoutés dans la base à la fin de la lecture
du fichier de zone.  Cela signifie qu'on peut très bien écrire le
CNAME d'abord, puis écrire le A ou le AAAA correspondant après.
Lorsqu'un CNAME pointe sur un nom inexistant, l'information est
signalée. Si vous avez deux fichiers de zones (f1 et f2 par exemple)
avec un CNAME dans f1 qui pointe sur un A dans f2, cela signifie
qu'il faut charger d'abord f2, puis ensuite f1. Dans le cas d'une
référence croisée (un CNAME dans f2 qui pointe en plus sur un A
dans f1), cela signifie qu'il faudra charger deux fois le même
fichier (f1 ou f2) pour résoudre la référence~: il faudra donc par
exemple charger f1, puis f2, puis f1 à nouveau. Lors du rechargement
d'une zone, les RR déjà introduits sont ignorés.

Le script \texttt {remplir-domaine} doit être modifié pour~:

\begin {itemize}
    \item le chemin de l'interprète Tcl~;
    \item le mot de passe d'accès à la base DNS~;
    \item le motif de détection de fin du prologue, si vous décidez d'en
	choisir un autre.
\end {itemize}

Le script \texttt {charger-domaines} enchaîne les appels individuels
à \texttt {remplir-domaine}. Vous devez modifier ce script pour
paramétrer le remplissage des domaines, dans le bon ordre, avec
éventuellement le rechargement de fichiers déjà introduits si vous
avez des références croisées.


\titreC {Script \texttt {remplir-grpdom}}

Le script \texttt {remplir-grpdom} associe une liste de domaines à
chaque groupe. De plus, cette liste de domaines est ordonnée selon
une classe de tri (les valeurs les plus proches de 0 sont les plus
prioritaires), de façon que chaque membre d'un groupe puisse voir
en premier les domaines qui le concernent.

Ce script est dirigé par un fichier \texttt {grpdom.txt} contenant des
lignes de la forme~:

\begin {quote}
    \textit {domaine} \texttt {ALLBUT}|\texttt {SET} \textit {tri}
	\textit {groupe} ... \textit {groupe}
\end {quote}

\begin {itemize}
    \item les lignes de type \texttt {SET} associent le domaine aux
	groupes désignés, avec la classe de tri spécifiée~;

    \item les lignes de type \texttt {ALLBUT} associent le domaine à
	tous les groupes (avec la classe de tri spécifiée), sauf
	ceux désignés explicitement.

\end {itemize}

Le script suppose que tous les groupes et les domaines cités dans
ce fichier existent dans la base. Les premiers ont été chargés par
le script \texttt {remplir-grpnet} et les seconds ont été chargés
par le script \texttt {remplir-domaine}.

Le script \texttt {remplir-grpdom} doit être modifié pour~:

\begin {itemize}
    \item le chemin de l'interprète Tcl~;
    \item le mot de passe d'accès à la base DNS.
\end {itemize}


\titreC {Script \texttt {remplir-rolemail}}

Le script \texttt {remplir-rolemail} initialise la liste des adresses
de messagerie, et leur associe un hébergeur. Pour plus d'information
sur la gestion des rôles de messagerie, voir l'annexe~\ref
{anx-rolemail} (page~\pageref {anx-rolemail}).

Ce script est dirigé par deux fichiers. Le premier est \texttt
{rolemail.txt} contenant des lignes de la forme~:

\begin {quote}
    \textit {adresse} [ \textit {nom-de-l'hébergeur} ]
\end {quote}

L'«~\textit {adresse}~» est l'adresse de messagerie pour laquelle
un MX doit être publié, et le «~\textit {nom-de-l'hébergeur}~»
est le nom de la machine hébergeant les boîtes aux lettres. Si ce
dernier n'est pas fourni, il correspondant par défaut à l'adresse
de messagerie.

Le deuxième fichier, \texttt {relaisdom.txt}, précise les relais
de messagerie associés à chaque domaine, qui seront publiés dans
les MX des adresses de messagerie spécifiées dans le précédent
fichier. Le fichier contient des lignes de la forme~:

\begin {quote}
    \textit {domaine}
	    \hspace* {2mm}
	    \textit {priorité} \textit {machine}
	    \hspace* {2mm} ... \hspace* {2mm}
	    \textit {priorité} \textit {machine}
\end {quote}

Le script suppose que tous les domaines et tous les relais existent
dans la base~: ils doivent avoir été chargés par les scripts \texttt
{remplir-domaine} et \texttt {remplir-grpdom}.

Si vous choisissez de ne pas utiliser les rôles de messagerie, videz
les deux fichiers. Vous pourrez toujours utiliser ultérieurement
ce script sur la base de production.

Le script \texttt {remplir-rolemail} doit être modifié pour~:

\begin {itemize}
    \item le chemin de l'interprète Tcl~;
    \item le mot de passe d'accès à la base DNS.
\end {itemize}


\titreC {Scripts \texttt {charger-zones} et \texttt {remplir-zone}}

Le script \texttt {remplir-zone} analyse un fichier de zone et
charge dans la base les informations de génération de zone~: le nom
et le type (normale, reverse IPv4 ou reverse IPv6) de la zone, le
critère de sélection des RR devant figurer dans la zone, le numéro
de version initial, le fichier de zone contenant le prologue, les
RR supplémentaires éventuels ainsi que la valeur initiale du flag
«~générer~».

Comme dans le script \texttt {remplir-domaine}, la fin du prologue
est déterminée par recherche d'une expression régulière dans le
fichier de zone. Là encore, cette expression est, par défaut~:

\begin {quote}
    \verb|^; COUPER ICI|
\end {quote}

Le numéro de version fourni en paramètre est le numéro initial
devant être inscrit dans la base. Il doit être de la forme AAAAJJMMnn
(voir annexe~\ref {version-soa}, page~\pageref {version-soa}). La
valeur du numéro de version que vous fournissez au script n'a pas
grande importance, à partir du moment où elle est antérieure à la
date courante, si vous mettez le flag de génération à 1~: la première
génération provoquera une actualisation automatique du numéro de
version.

Le prologue contient le RR de type SOA de la zone. Ce SOA contient
en particulier le numéro de version. Lors de la génération des
zones, la chaîne «~\texttt {\%ZONEVERSION\%}~» sera substituée par
le numéro de version courant dans la base (en l'actualisant bien
sûr). Pour cette raison, le script \texttt {remplir-zone} recherche
dans le SOA le numéro de version courant et le substitue par la
chaîne «~\texttt {\%ZONEVERSION\%}~» lors du remplissage du prologue
dans la base. Ceci est réalisé grâce à une expression régulière,
qui vaut par défaut~:

\begin {quote}
    \verb|^([ \t]+)([0-9]+)([ \t]+;[ \t]*Version.*)|
\end {quote}

Cette expression recherche une ligne décomposée en trois parties
par les parenthèses~: la première est située avant le numéro de
version, la deuxième est le numéro de version lui-même et la troisième
est ce qui suit (soit le commentaire «~\texttt {; Version}~» ici).
Grâce à cette expression régulière, la cohérence du numéro de version
actuel est vérifiée, puis il est remplacé par la fameuse chaîne
«~\texttt {\%ZONEVERSION\%}~».

Le script \texttt {remplir-domaine} doit être modifié pour~:

\begin {itemize}
    \item le chemin de l'interprète Tcl~;
    \item le mot de passe d'accès à la base DNS~;
    \item le motif de détection de fin du prologue, si vous décidez d'en
	choisir un autre~;
    \item le motif de détection du numéro de version dans le SOA, si
	vous décidez d'en choisir un autre~;
\end {itemize}

Le script \texttt {charger-zones} enchaîne les appels individuels
à \texttt {remplir-zone} avec les bons paramètres.  Vous devez
modifier ce script pour paramétrer le remplissage des zones.


\titreC {Script \texttt {remplir-triggers}}

Le script \texttt {remplir-triggers} est indépendant des données
du chargement initial de la base. Il implémente les \textit {triggers}
associés à certaines tables, qui permettent en particulier de mettre
le flag de génération d'une ou plusieurs zones à 1 lorsqu'un RR est
modifié. Il implémente également les fonctions appelées lors de
l'exécution de ces \textit {triggers}.

Étant donné que les \textit {triggers} pénalisent les performances,
ils ne sont activés qu'à la fin du chargement initial. Rassurez-vous,
en temps normal, avec des modifications unitaires, l'impact sur les
performances est absolument négligeable.

Le script  \texttt {remplir-triggers} doit être modifié pour~:

\begin {itemize}
    \item le mot de passe d'accès à la base DNS.
\end {itemize}


\titreC {Exécution !}

Une fois tous les scripts modifiés selon vos souhaits, lancez le
script \texttt {./inst/init-base}. Lorsque vous n'aurez plus d'erreurs
et que vous saurez expliquer tous les messages d'avertissement, vous
pourrez vérifier si l'installation s'est bien passée. Par exemple, vous
pouvez utiliser «~\verb|psql|~» pour vérifier quelques tables~:

\begin {quote}
\small
\begin {verbatim}
$ psql dns dns
dns=# \encoding latin9
dns=# SELECT * FROM etablissement ;    -- lister les établissements
 idetabl |   nom
---------+---------
       1 | UM
       2 | ESIATF
       3 | INCONNU
(4 rows)

dns=# SELECT COUNT(*) FROM rr ;        -- compter le nombre de noms enregistrés
 count
-------
    36
(1 row)

dns=# SELECT COUNT(*) FROM rr_ip ;     -- compter le nombre d'adresses IP
 count
-------
    39
(1 row)

dns=# \q
\end{verbatim}
\end {quote}

Essayez quelques-unes des tables de l'application (voir annexe~\ref
{anx-mcd}, page~\pageref {anx-mcd}). Si les valeurs sont correctes,
vous avez terminé la phase délicate de l'installation, vous pouvez
maintenant passer à la suite.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%}}
% Installation de l'application
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\titreA {Installation de l'application WebDNS}

\titreB {Installation des fichiers de l'application}
    \label {install-dns}

Choisissez un répertoire pour placer les pages Web et les scripts
CGI de l'application, qui ne doit pas être le répertoire dans lequel
vous avez détarré l'application. Dans l'installation par défaut,
ce répertoire est nommé \verb|/local/services/www/applis/dns/|.

\begin {itemize}
    \item
	\cbstart%1.5
	si vous souhaitez utiliser HTG, vous n'avez rien à faire~:
	les fichiers sont déjà dans le répertoire \verb|./www/lib/|.
	Vous pouvez éventuellement modifier les parties «~bannière~»,
	«~titrepage~» et «~bandeau~» à votre convenance~;
	\cbend%1.5

    \item si vous souhaitez concevoir des nouvelles pages à trous,
	installez-les dans le répertoire  \verb|./www/lib/|.
	Vous devrez supprimer chaque fichier «~.htgt~» et le remplacer
	par un fichier «~.html~» équivalent, en respectant le nom des
	trous que les scripts CGI s'attendent à trouver (voir
	annexe~\ref {anx-trous}, page~\pageref {anx-trous}).  Vous
	prendrez soin également d'adapter les fichiers LaTeX
	\verb|liste.tex| et \verb|listedes.tex|.

\end {itemize}

Rendez-vous ensuite dans le répertoire \verb|./www/| et éditez le
fichier \texttt {Makefile}. Modifiez les variables~:

\begin {tabular} {|l|p{140mm}|} \hline
    \multicolumn {1} {|c|} {\textbf {Variable}} &
	    \multicolumn {1} {|c|} {\textbf {Signification}}
    \\ \hline
    \texttt {TCLSH} &
	localisation de l'exécutable \texttt {tclsh}
	\\ \hline
    \texttt {BASE} &
	nom de la base de données et paramètres d'ouverture
	\\ \hline
    \texttt {AUTH} &
	méthode d'authentification (\texttt {postgresql} ou \texttt
	{ldap}) et paramètres spécifiques
	\\ \hline
    \cbstart%1.5
    \texttt {LOG} &
	paramètres d'accès au journal des modifications de l'application
	\cbend%1.5
	\\ \hline
    \texttt {HOMEURL} &
	chemin relatif à la racine de l'arborescence Web
	\\ \hline
    \texttt {NOLOGIN} &
	nom du fichier à créer pour rentrer en mode
	«~maintenance~»
	\\ \hline
    \texttt {DEFUSER} &
	utilisateur par défaut dans les scripts auxiliaires de
	modification de la base (ajout d'adresse IP, d'adresse MAC,
	etc.)
	\\ \hline
    \texttt {DESTDIR} &
	localisation de l'application dans l'arborescence Web
	\\ \hline
    \texttt {PKGTCL} &
	localisation des packages Tcl inclus avec l'application
	\\ \hline
    \texttt {HTG} &
	localisation de l'exécutable \texttt {htg}
	\\ \hline
    \cbstart%1.5
    \texttt {MODLHTG} &
	modèle à utiliser. Ceci n'est normalement pas à modifier car
	le modèle utilisé est défini lors de l'installation de HTG
	(voir~\ref {htg-webdns}, page~\pageref {htg-webdns})
	\cbend%1.5
	\\ \hline
    \texttt {ROOT} &
	utilisateurs (Apache) habilités à intervenir en mode
	«~maintenance~»
	\\ \hline
    \texttt {INTERVALLE} &
	intervalle entre deux générations de zones (doit correspondre à
	la valeur spécifiée avec \texttt {cron}) afin d'informer les
	utilisateurs
	\\ \hline
    \texttt {DOCDNS} &
	URL d'une page présentant votre architecture DNS, pointée par
	diverses pages de l'application.
	\\ \hline
    \texttt {VERSION} &
	Numéro de version de l'application. Normalement pas à modifier.
	\\ \hline
    \texttt {COULEUR} &
	Couleur de fond des boutons de validation. Normalement pas à modifier.
	\\ \hline
    \texttt {PASSWDURL} &
	URL de changement de mot de passe, doit pointer vers WebAuth
	ou vers votre application de changement de mot de passe
	\\ \hline
\end {tabular}


Puis, lancez \texttt {make} (dans le répertoire \verb|./www/|) pour
installer tous les fichiers de l'application dans l'arborescence
Web.


\titreB {Configuration du serveur Apache}
    \label {config-apache}

Le serveur Apache doit être configuré pour~:

\begin {itemize}
    \item autoriser l'accès en consultation à
	\verb|/local/services/www/applis/dns/|
    \item autoriser l'accès en exécution CGI à
	\verb|/local/services/www/applis/dns/bin/|
    \item interdire tout accès à
	\verb|/local/services/www/applis/dns/lib/|
\end {itemize}

Ceci peut être réalisé grâce aux quelques lignes suivantes (voir
\verb|./inst/httpd.conf|) dans le fichier \texttt {httpd.conf} de
configuration d'Apache, que vous prendrez soin d'adapter~:

\begin {quote}
    \small
    \verbatiminput {../inst/httpd.conf}
\end {quote}

Ces lignes font référence à la directive \texttt {ErrorDocument}
pour renvoyer une page d'erreur appropriée en cas d'échec
d'authentification~; si vous n'avez pas une telle page, qui doit
forcément être externe à l'application, supprimez la ligne.

\titreC {Authentification PostgreSQL}

Si vous utilisez WebAuth, vous pouvez configurer l'authentification
pour l'accès à WebDNS de manière similaire (voir~\ref {auth-pgsql.conf},
page~\pageref {auth-pgsql.conf}).

\titreC {Authentification LDAP}

Si vous utilisez une authentification LDAP, vous pouvez vous inspirer
de la configuration suivante, que vous adapterez en fonction de
votre DIT et de votre schéma LDAP~:

\begin {quote}
    \small
    \verbatiminput {../inst/auth-ldap.conf}
\end {quote}


\titreB {Paramétrage de l'application}

Une fois les étapes précédentes effectuées, vous devriez être en mesure
d'accéder à l'URL de votre application.  Vous pouvez alors rentrer
dans le module «~administration~» pour finaliser les paramétrages.

En particulier, pensez à vérifier et modifier les droits de votre
groupe, pour avoir accès à tous les réseaux que vous êtes susceptible
de gérer, par l'intermédiaire du menu de \textit {modification des
caractéristiques d'un groupe}.


\titreB {Génération des zones}
    \label {generer-zone}

Les scripts \texttt {mkzones} et \texttt {generer-zone} doivent
tous deux être copiés du répertoire \texttt {./expl/} vers le serveur
DNS. Pour des raisons de sécurité, le mot de passe d'accès à la
base figurant dans le script \texttt {generer-zone}, vous aurez
intérêt à installer ces scripts sous le compte de votre utilisateur
\texttt {bind} ou équivalent, si vous en avez un, et illisibles par
tout autre utilisateur que le propriétaire.


\titreC {Script \texttt {generer-zone}}

Le script \texttt {generer-zone} a deux comportements différents~:

\begin {itemize}
    \item sans argument, il affiche sur la sortie standard la liste
	des zones qui ont été modifiées depuis la dernière génération
	(c'est-à-dire la liste des zones pour lesquelles l'attribut
	«~generer~» vaut 1)~;

    \item avec un argument (un nom de zone), il procède à la
	génération de la zone sur la sortie standard, et remet
	l'attribut «~generer~» à 0).

\end {itemize}

Ce script doit être modifié pour indiquer~:

\begin {itemize}
    \item le chemin vers l'interprète Tcl~;

    \item le nom du serveur de données (sur lequel vous aurez pris
	soin d'autoriser l'accès, voir~\ref {acces-pgsql}, page~\pageref
	{acces-pgsql})~;

    \item le mot de passe d'accès à la base.
\end {itemize}

Une fois ce script modifié, vous pouvez l'installer dans le répertoire
de votre choix.


\titreC {Script \texttt {mkzones}}

Le script \texttt {mkzones} est conçu pour être lancé par \texttt
{cron}, par exemple toutes les 10~minutes (soit au maximum 144\footnote
{Ceci est théoriquement supérieur à 99 modifications autorisées par
le numéro de version, mais dans la pratique, cette limite n'a jamais
été rencontrée. Si cela devait être le cas, la génération échouerait,
jusqu'au lendemain.} modifications par jour), avec une entrée de
la forme~:

\begin {quote}
\small
\begin {verbatim}
#
# La crontab de l'utilisateur "bind"
#
# Historique
#   2002/05/02 : génération des zones DNS à partir de la base
#

SHELL = /bin/sh
MAILTO = hostmaster@u-strasbg.fr

*/10 * * * * /local/sbin/mkzones
\end{verbatim}
\end {quote}


Le corps du script est très simple~: un premier appel à \texttt
{generer-zone} permet de récupérer la liste des zones à générer.
Cette liste est utilisée dans une boucle qui génère chaque zone
dans le répertoire temporaire. Si au moins une zone a été générée
avec succès, le fichier correspondant est déplacé vers le répertoire
où le serveur DNS s'attend à trouver les zones, puis le serveur est
stimulé pour relire les fichiers.

Pour être installé~:

\begin {itemize}
    \item vous devez avoir au préalable modifié et installé le
	script \texttt {generer-zone}~;

    \item vous devez adapter \texttt {mkzones} pour votre usage local~;

    \item vous devez copier \texttt {mkzones} vers le serveur DNS~;

    \item et vous devez enfin activer la crontab ci-dessus.

\end {itemize}


\titreB {Génération des routages de messagerie}
    \label {generer-routages}

Si vous utilisez les «~rôles de messagerie~» (voir~\ref {anx-rolemail},
page~\pageref {anx-rolemail}), vous souhaitez sans doute générer
dynamiquement le fichier de routage de messagerie utilisé par \texttt
{sendmail} ou équivalent.

Pour vous aider dans cette tâche, les scripts \texttt {mkroutages}
et \texttt {generer-routages} doivent tous deux être copiés du
répertoire \texttt {./expl/} vers les relais de messagerie. Pour
des raisons de sécurité, le mot de passe d'accès à la base figurant
dans le script \texttt {generer-routages}, vous aurez intérêt à
installer ces scripts sous le compte d'un utilisateur spécifique
et les rendre illisibles par tout autre utilisateur que le propriétaire.


\titreC {Script \texttt {generer-routages}}

Le script \texttt {generer-routages} génère sur la sortie standard
un fichier prêt pour être utilisé comme table de routages avec le Kit
Jussieu de configuration de \texttt {sendmail}, c'est-à-dire une liste
de lignes de la forme~:

\begin {quote}
    \textit {adresse}
	\hspace* {5mm}
	\texttt {smtp.[}\textit {relais\/}\texttt {]}
\end {quote}

où \textit {adresse} est le nom du «~rôle de messagerie~», \textit
{relais} est l'adresse de l'hébergeur des boîtes aux lettres pour
cette adresse de messagerie, telle que définie dans la base. Enfin,
le mot-clef \texttt {smtp} indique que le \textit {mailer} SMTP de
\texttt {sendmail} doit être utilisé, et les crochets indiquent que
l'envoi doit être effectué directement vers le relais, sans tenir
compte des MX du DNS. Pour plus d'information, consulter la
documentation du Kit Jussieu\footnote {\htmlurl
{http://www.kit-jussieu.org}}.

Ce script doit être modifié pour indiquer~:

\begin {itemize}
    \item le chemin vers l'interprète Tcl~;

    \item le nom du serveur de données (sur lequel vous aurez pris
	soin d'autoriser l'accès, voir~\ref {acces-pgsql}, page~\pageref
	{acces-pgsql})~;

    \item le mot de passe d'accès à la base.
\end {itemize}

Une fois ce script modifié, vous pouvez l'installer dans le répertoire
de votre choix.


\titreC {Script \texttt {mkroutages}}


Le script \texttt {mkroutages} est conçu pour être lancé par \texttt
{cron}, par exemple toutes les 5~minutes avec une
entrée de la forme~:

\begin {quote}
\small
\begin {verbatim}
#
# La crontab de "root"
#

SHELL = /bin/sh
MAILTO = hostmaster@u-strasbg.fr

*/5 * * * * /local/sbin/mkroutages
\end{verbatim}
\end {quote}

Le script fonctionne en concaténant deux parties~:

\begin {itemize}
    \item la première est issue d'un fichier \texttt {routages.prologue},
	contenant tous les cas particuliers, repris sans modification
	d'aucune sorte~;

    \item la deuxième est la sortie du script \texttt {generer-routages}.

\end {itemize}

Le script \texttt {mkroutages} concatène ces deux parties, compare
le résultat à l'existant, et installe la nouvelle version si elle
diffère.  L'ancienne version est conservée avec le suffixe \texttt
{.old}. L'utilitaire \texttt {makemap} est alors appelé pour
reconstruire le fichier \texttt {.db} correspondant et rendre les
données accessibles à \texttt {sendmail}.

Pour être installé~:

\begin {itemize}
    \item vous devez avoir au préalable modifié et installé le
	script \texttt {generer-routages}~;

    \item vous devez adapter \texttt {mkroutages} pour votre usage
	local~;

    \item vous devez copier \texttt {mkroutages} vers vos relais de
	messagerie~;

    \item et vous devez enfin activer la crontab ci-dessus sur chacun
	des relais de messagerie..

\end {itemize}


\cbstart%1.5
\titreB {Gestion de SMTP authentifié}
    \label {generer-droitsmtp}

Si vous souhaitez utiliser SMTP authentifié dans votre environnement,
comme indiqué en~\ref {pres-droitsmtp} (page~\pageref {pres-droitsmtp}),
vous devez implémenter une politique de filtrage interdisant les
connexions en provenance de clients SMTP non authentifiés, sauf
exception dûment enregistrée et validée dans WebDNS.

Sur les relayeurs de messagerie de votre domaine, vous devez donc
activer des filtres TCP en fonction des informations de WebDNS.

\titreC {Script \texttt {mkdroitsmtp}}

Le script \texttt {mkdroitsmtp} est fourni à titre d'exemple. Il
fonctionne sur FreeBSD version 8 (minimum), et utilise \texttt {pf}
(PacketFilter) issu d'OpenBSD comme outil de filtrage IP.

Par exemple, les règles de filtrage \texttt {pf} peuvent être les
suivantes~:

\begin {quote}
    \small
    \verbatiminput {../inst/pf.conf}
\end {quote}

Le rôle du script consiste à créer un fichier pour stocker la table
\texttt {droitsmtp} et à activer cette table. Il commence par
récupérer une liste d'exceptions (sous forme d'un fichier contenant
une liste d'adresses à systématiquement autoriser), puis ajoute la
liste des adresses IP ayant l'attribut «~droit d'émettre en SMTP
non authentifié~». Ensuite, le fichier ainsi constitué est testé
en utilisant l'utilitaire \texttt {pfctl}. Enfin, le fichier est
envoyé et activé vers les autres relayeurs via un script \texttt
{cpmh} (non fourni).

Le script \texttt {mkdroitsmtp} doit être lancé par \texttt {cron},
par exemple toutes les minutes, avec une entrée de la forme~·

\begin {quote}
\small
\begin {verbatim}
#
# La crontab de "root"
#
SHELL = /bin/sh
MAILTO = hostmaster@u-strasbg.fr

* * * * *  lockf -t 30 /tmp/droitsmtp.lock /local/sbin/mkdroitsmtp
\end{verbatim}
\end {quote}

La commande \texttt {lockf} empêche l'exécution simultanée de deux
instances du script.
\cbend%1.5

\titreB {Génération de la configuration DHCP}
    \label {generer-dhcp}

L'application WebDNS gère les associations entre adresses IP et
adresses MAC, ainsi que les plages d'adresses réservées pour
l'allocation dynamique. Vous pouvez donc facilement générer la
configuration d'un serveur DHCP.

De plus, grâce au mécanisme standard du «~relayage DHCP~» sur les
routeurs, vous pouvez offrir un service DHCP centralisé sur un
campus.


\titreC {Configuration du serveur DHCP}
  \label {dhcpd.conf}

L'exemple de configuration ci-dessous repose sur l'utilisation du
serveur DHCP de l'ISC\footnote {\htmlurl {http://www.isc.org/}}.

\begin {quote}
\small
\begin {verbatim}
log-facility local2 ;    # logs distincts des autres démons
authoritative ;
ddns-update-style none ;

lease-file-name "/local/dhcpd/db/leases" ;

option domain-name-servers ns1.u-strasbg.fr;
option ntp-servers ntp.u-strasbg.fr ;
option nntp-server news.u-strasbg.fr ;

allow duplicates ;       # double boot: même mac, mais pas même client id
deny declines ;          # ignorer les refus des clients

ping-check false ;       # ne pas essayer de vérifier les adr dynamiques

max-lease-time 7200 ;    # 2 heures
default-lease-time 600 ; # 10 minutes

include "/local/dhcpd/gen.conf" ;    # tout ce qui est généré est là-dedans
\end{verbatim}
\end {quote}

Comme on peut le voir, toute la partie dynamique de la configuration
est concentrée dans le fichier \texttt {gen.conf} inclus à la
dernière ligne. Ce mécanisme d'inclusion permet de simplifier la
génération.


\titreC {Activation du relayage DHCP}

Si vous souhaitez offrir le service DHCP à des sous-réseaux, vous
devez activer le relayage DHCP sur vos routeurs. La suite vous donne
quelques éléments pour 


\titreD {Activation du relayage DHCP sur Juniper}

Pour activer le relayage sur un routeur Juniper, vous devez saisir
les lignes suivantes dans la configuration~:

\begin {quote}
\small
\begin {verbatim}
forwarding-options {
  helpers {
    bootp {
      description "Service DHCP pour les sous-reseaux d'Osiris" ;
      server 130.79.200.2 ;     /* adresse du serveur DHCP */
      interface {
        all {
          no-listen ;           /* par défaut, pas de DHCP sur les interfaces */
        }
        ge-1/2/0.5 ;            /* mais activé sur le Vlan 5 de l'interface */
        ge-2/1/2.546 ;          /* et sur le vlan 546 */
        ...
      }
    }
  }
}
\end{verbatim}
\end {quote}

Bien entendu, vous devez vérifier également que les ports 67 et 68
ne sont pas filtrés.


\titreD {Activation du relayage DHCP sur Cisco}

Pour activer le relayage sur un routeur Cisco, vous devez saisir
les lignes suivantes dans la configuration, au niveau de l'interface
sur laquelle sont diffusées les requêtes DHCP/BOOTP~:

\begin {quote}
\small
\begin {verbatim}
interface FastEthernet0/0
  ip helper-address 130.79.200.2
\end{verbatim}
\end {quote}


\titreD {Activation du relayage DHCP sur des PC}

Si vous utilisez des PC en guise de routeur (cas d'un garde-barrière
routé par exemple), vous pouvez utiliser le logiciel de relayage fourni
avec le serveur DHCP de l'ISC.


\titreC {Script \texttt {generer-dhcp}}

Le script \texttt {generer-dhcp} a deux comportements différents suivant
l'argument fourni~:

\begin {itemize}
    \item avec l'argument \texttt {test}, il teste si la configuration
	DHCP doit être regénérée, grâce à la table \texttt {dhcp} de la
	base DNS (qui contient une seule colonne et une seule
	ligne, valant soit 0 soit 1)~;

    \item avec l'argument \texttt {gen}, il génère la configuration
	DHCP (sans tester la table \texttt {dhcp}), puis remet cette
	table \texttt {dhcp} à 0.

\end {itemize}

Le fichier généré sur la sortie standard est prêt pour être utilisé
comme partie de \texttt {dhcpd.conf} (fichier \texttt {gen.conf},
voir~\ref {dhcpd.conf}, page~\pageref {dhcpd.conf}).  Il contient
en particulier~:

\begin {itemize}
    \item les déclarations des réseaux configurés pour DHCP, avec
	les paramètres associés (masque et routeur), et les intervalles
	dynamiques éventuellement déclarés~;

    \item les déclarations des machines individuelles~;

    \item de plus, si des profils DHCP sont définis dans la base,
	ceux-ci sont restitués dans un bloc «~\textit {group}~»
	avec le texte défini pour ce profil. Les déclarations des
	machines individuelles avec ce profil sont ensuite listées
	dans ce bloc.

\end {itemize}

Le script doit être modifié pour indiquer~:

\begin {itemize}
    \item le chemin vers l'interprète Tcl~;

    \item le nom du serveur de données (sur lequel vous aurez pris
	soin d'autoriser l'accès, voir~\ref {acces-pgsql}, page~\pageref
	{acces-pgsql})~;

    \item le mot de passe d'accès à la base.
\end {itemize}

Une fois ce script modifié, vous pouvez l'installer dans le répertoire
de votre choix.


\titreC {Script \texttt {mkdhcp}}


Le script \texttt {mkdhcp} est conçu pour être lancé par \texttt
{cron}, par exemple toutes les 5~minutes, par exemple avec une
entrée de la forme~:

\begin {quote}
\small
\begin {verbatim}
#
# La crontab de "root"
#

SHELL = /bin/sh
MAILTO = hostmaster@u-strasbg.fr

*/5 * * * * /local/sbin/mkdhcp
\end{verbatim}
\end {quote}

Le principe de fonctionnement du script est de générer un fichier
\texttt {gen.conf} (voir section précédente), puis en testant la
syntaxe du nouveau fichier de configuration. S'il n'y a aucun
problème, le démon \texttt {dhcpd} est redémarré.

Pour être installé~:

\begin {itemize}
    \item vous devez avoir au préalable modifié et installé le
	script \texttt {generer-dhcp}~;

    \item vous devez adapter \texttt {mkdhcp} pour votre usage
	local~;

    \item vous devez copier \texttt {mkroutages} vers votre serveur
	DHCP~;

    \item et vous devez enfin activer la crontab ci-dessus sur votre
	serveur DHCP.

\end {itemize}


\titreB {Utilitaires complémentaires}

L'application WebDNS contient également quelques programmes conçus
pour être utilisés hors contexte Web, ce qui permet d'automatiser
certaines tâches, comme l'ajout de machine, d'adresse IP, d'adresse
MAC, etc.

\titreC {Localisation des utilitaires}

Les programmes sont localisés dans le répertoire \verb|./www/lib/util/|.
Comme le reste de l'application, ils contiennent des paramètres
qu'il serait fastidieux de changer fichier par fichier.  Ils sont
donc modifiés et installés, comme les autres scripts CGI ou les
pages HTML à trous, vers l'arboresnce Web par \texttt {make}
(voir~\ref {install-dns}, page~\pageref {install-dns}).

Une fois localisés dans l'arborescence Web, ils peuvent être utilisés
comme n'importe quel programme. Par exemple~:

\begin {quote}
    \verb|/local/services/www/applis/dns/lib/util/dnsaddhost toto.machin.fr 192.168.1.2|
\end {quote}

Vous pourrez avantageusement ajouter ce répertoire dans votre \texttt
{PATH}, ou alors réaliser des liens symboliques, comme~:

\begin {quote}
    \verb|cd /local/sbin ; ln -s /local/services/www/applis/dns/lib/util/* .|
\end {quote}


\titreC {Description des utilitaires}

Les programmes sont les suivants~:

\begin {itemize}
    \item \texttt {\textbf {dnsaddhost} \textit {fqdn} \textit {ip}}

	Ajoute une machine avec l'adresse IP donnée, ou ajoute une
	adresse IP supplémentaire à une machine déjà existante.

	Exemple~: \verb|dnsaddhost toto.machin.fr 192.168.1.2|

    \item \texttt {\textbf {dnsdelhost} \textit {fqdn}}

	Supprime la machine indiquée.

	Exemple~: \verb|dnsdelhost toto.machin.fr|

    \item \texttt {\textbf {dnsaddalias} \textit {alias} \textit {fqdn}}

	Ajoute un alias à une machine existante.

	Exemple~: \verb|dnsaddhost alias.machin.fr toto.machin.fr|

    \item \texttt {\textbf {dnsdelip} \textit {ip}}

	Supprime l'adresse IP, et éventuellement la machine si elle
	n'a que cette adresse IP.

	Exemple~: \verb|dnsdelip 192.168.1.2|

    \item \texttt {\textbf {dnsmodattr} \textit {fqdn} \textit {clef} \textit
	{val}} [ \texttt {\textit {clef} \textit {val}} ...]

	Modifie les attributs d'une machine. Les attributs (clefs)
	peuvent être~:

	\begin {itemize}
	    \item \texttt {mac}~: une adresse MAC
	    \item \texttt {dhcpprofil}~: un nom de profil DHCP existant
	    \item \texttt {hinfo}~: un nom de type de machine
	    \item \texttt {respnom}~: le nom du responsable
	    \item \texttt {respmel}~: l'adresse électronique du responsable
	    \item \texttt {commentaire}~: le commentaire associé à la machine
	    \cbstart%1.5
	    \item \texttt {droitsmtp}~: le droit (1) ou non (0)
		d'émettre en SMTP non authentifié
	    \item \texttt {ttl}~: le TTL de la machine (ou vide)
	    \cbend%1.5
	\end {itemize}

	Chaque attribut peut être cité au plus une fois. Plusieurs
	attributs peuvent être modifiés au cours de la même opération.

	Exemple~: \verb|dnsdelip toto.machin.fr mac 01:02:03:04:05:06 dhcpprofil un-profil|

    \item \texttt {\textbf {dnsreadprol} \textit {zone}}

	Lit le prologue associé à la zone et l'affiche sur la sortie
	standard.

	Exemple~: \verb|dnsreadprol machin.fr > $HOME/prologue|

    \item \texttt {\textbf {dnswriteprol} \textit {zone} \textit {fichier}}

	Écrit le prologue associé à la zone, à partir du fichier, dans
	la base.

	Exemple~: \verb|dnswriteprol machin.fr $HOME/prologue|

\end {itemize}


\titreB {Scripts auxiliaires de maintenance de la base}

L'application WebDNS est complétée par des scripts auxiliaires,
lancés par \texttt {cron} sur le serveur de données, pour réaliser
les opérations de maintenance et de sauvegarde de la base PostgreSQL

\titreC {Script \texttt {quotidien}}

Le premier script,
\verb|./expl/quotidien|, effectue une sauvegarde dans le répertoire
\texttt {./dump}, ainsi qu'un «~\texttt {VACUUM}~» (spécifique
PostgreSQL) sur la base.

De plus, il permet également de créer une copie de la base
d'exploitation dans une base de développement, mais ceci n'est pas
activé par défaut.

Après l'avoir modifié selon vos besoins, vous pouvez le lancer
toutes les nuits par \texttt {cron}, de préférence avant minuit
pour avoir des noms de fichiers de sauvegarde représentatifs du
jour sauvegardé. Par exemple, voici un exemple de \texttt {crontab}
utilisé (voir fichier \texttt {./expl/crontab.dns})~:

\begin {quote}
\small
\begin {verbatim}
40 22 * * * $HOME/expl/quotidien
\end{verbatim}
\end {quote}

\titreC {Script \texttt {sauvegarde}}

À l'usage, il appert que les données contenues dans la base DNS
revêtent un caractère très sensible et leur perte peut s'avérer
catastrophique. Si vous êtes conscient de cet enjeu, vous trouverez
dans le script \verb|./expl/sauvegarde| le moyen d'effectuer une
sauvegarde toutes les heures~; celle-ci peut par exemple être lancée
par \texttt {cron}~:

\begin {quote}
\small
\begin {verbatim}
#
# Sauvegarde toutes les heures ouvrées du lundi au vendredi
# Sauvegarde une fois par jour le samedi et le dimanche
#
0 8-18 * * Mon-Fri $HOME/expl/sauvegarde
0 12   * * Sat,Sun $HOME/expl/sauvegarde
\end{verbatim}
\end {quote}

Il est vivement conseillé d'appliquer cette politique de sauvegarde...

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%}}
% Conclusion
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\titreA {Conclusion}

Si tout fonctionne correctement, n'oubliez pas d'envoyer une bouteille
de champagne aux auteurs...



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%}}
% Annexe - MCD
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\appendix
% le premier titre de l'annexe est un titreAN pour éviter un cleardoublepage
\titreAN {Modèles des données}
    \label {anx-mcd}

\titreB {WebDNS}

\figpswidth {mcd-dns} {150mm}

\titreB {WebAuth}

\figpswidth {mcd-auth} {100mm}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%}}
% Annexe - Paramétrage de l'application
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\titreA {Paramétrage de WebDNS}
    \label {parametrage}

L'application WebDNS permet de gérer et déléguer finement des droits
à des correspondants réseau. Il importe donc de bien comprendre les
enjeux du paramétrage afin de réussir son implantation.

Le lecteur intéressé pourra se référer avantageusement au modèle
des données, fourni en annexe~\ref {anx-mcd} (page~\pageref {anx-mcd}).

\titreB {Les réseaux}

Un réseau doit être compris comme un «~domaine de broadcast~»\footnote
{Évitez d'identifier votre classe B comme un seul réseau...},
autrement dit un réseau relie un ensemble de machines qui peuvent
communiquer entre elles sans utiliser de routeur intermédiaire.

À chaque réseau sont associées deux \textbf {adresses}~: un CIDR \textbf
{IPv4} (de la forme «~130.79.201.128/25~», par exemple) et
l'équivalent \textbf {IPv6} (de la forme «~2001:660:2402:1::/64~»
par exemple). L'une des deux adresses peut bien évidemment être
vide.

Les autres attributs d'un réseau sont~:

\begin {itemize}
    \item son \textbf {nom} (chaîne alphanumérique sans restriction)

    \item son \textbf {établissement}~: si vous n'avez qu'un seul établissement
	(réseau d'établissement et non réseau métropolitain ou
	régional), vous pourrez remplacer la notion d'établissement par
	la notion de service, de laboratoire, de client, etc.

    \item sa «~\textbf {communauté}~»~: cette notion permet, sur
	Osiris, d'identifier les réseaux d'enseignement, de recherche,
	d'administration, de backbone, d'interconnexion, etc.  Vous
	pouvez l'utiliser de cette manière, l'utiliser comme un
	«~tag~» pour un autre usage, ou ne pas considérer ce champ.
	Cet attribut n'a pas d'autre utilité que la documentation
	des réseaux.

    \item sa \textbf {localisation} géographique~: texte libre,
	par exemple une adresse, un bâtiment, un étage, etc.

    \item un \textbf {commentaire}~: texte libre.

    \item
	une \textbf {passerelle IPv4} et une \textbf {passerelle IPv6}.
	Seule la passerelle IPv4 est utilisée pour le moment, en cas
	d'activation du service DHCP.

    \item un indicateur d'\textbf {activation DHCP}, qui permet de
	signaler que les adresses MAC de ce réseau doivent être prises
	en compte lors de la génération du fichier \texttt {dhcpd.conf}
	(voir~\ref {dhcpd.conf}, page~\pageref {dhcpd.conf}).

\end {itemize}

La notion de réseau est utilisée, à l'heure actuelle,
principalement
pour des raisons cosmétiques, afin de permettre à un
correspondant de choisir dans une liste le réseau qu'il souhaite
consulter. Toutefois, cette notion est appelée à évoluer avec la
mise en place de nouvelles fonctionnalités dans les versions
ultérieures de WebDNS. C'est pourquoi nous vous recommandons de
bien renseigner ces informations\footnote {Et c'est l'occasion de
documenter vos réseaux, non~? ;-)}.


\titreB {Les correspondants et les groupes}

L'application WebDNS est conçue pour déléger la gestion du DNS à
un ensemble de \textbf {correspondants réseau}. Le correspondant
est donc la personne physique qui va réaliser les opérations d'ajout,
de modification et de suppression des informations dans la base.

Peu d'informations sont associées à un correspondant dans la base,
car la plupart sont inscrites dans le système d'authentification
externe (annuaire LDAP, ou base PostgreSQL gérée par l'application
WebAuth). Les informations spécifiques à WebDNS sont~:

\begin {itemize}
    \item le \textbf {login} du correspondant, faisant ainsi la
	jonction avec l'application WebAuth~;

    \item un indicateur servant à savoir si un correspondant est
	\textbf {présent} ou non.  Cet indicateur autorise le
	correspondant à se connecter à l'application. On met cet
	indicateur à 0 lorsque le correspondant est parti (départ,
	mutation, etc.), afin de le laisser inactif dans la base~:
	en effet, il peut y avoir des informations à son nom, qui
	deviendraient orphelines si le compte était simplement
	détruit. Si plus aucune information ne fait référence au
	correspondant, le compte peut bien sûr être directement
	détruit.

    \item le \textbf {groupe} auquel appartient le correspondant.
	Tout correspondant appartient à un (et un seul) groupe.

\end {itemize}

C'est par l'intermédiaire des \textbf {groupes} que les droits sont
attribués aux correspondants. Ces droits peuvent être~:

\begin {itemize}
    \item le droit de déclarer des noms dans un domaine
    \item le droit de déclarer des adresses IP dans un intervalle
    \item le droit de consulter des réseaux
    \item le droit de déclarer des rôles de messagerie pour un domaine
    \item le droit d'administrer des intervalles d'allocation DHCP
	dynamique et d'utiliser des profils DHCP
    \cbstart%1.5
    \item le droit d'autoriser des machines à émettre en sMTP non
	authentifié
    \item le droit d'éditer le TTL des machines individuelles
    \cbend%1.5
    \item le droit d'administrer la base
\end {itemize}

Deux groupes différents peuvent avoir des droits qui se chevauchent.
Par exemple, on peut imaginer un droit sur un réseau pour les
correspondants d'une composante ou d'un laboratoire (formant un
groupe), et des droits sur ce même réseau pour les personnes du
service informatique d'établissement (formant un autre groupe).

Les groupes décrits ici (appelés groupes WebDNS) ne doivent pas
être confondus avec les groupes de l'application WebAuth~: les
groupes WebDNS permettent d'attribuer des droits spécifiques à
l'application WebDNS, alors que les groupes WebAuth permettent à
un serveur tel que Apache à délimiter l'accès à des portions d'une
arborescence Web.


\titreB {Les domaines et les \textit {resource-records}}

Un domaine est un ensemble de \textit {resource-records} (encore
appelés RR).

Chaque RR porte un \textbf {nom} (sans point à l'intérieur), conforme
à la RFC~1035, et fait référence au \textbf {domaine}. De plus, un RR~:

\begin {itemize}
    \item porte un type (encore appelé \textbf {hinfo}) paramétrable
	par l'administrateur de la base~;

    \item est géré par un \textbf {responsable} (avec un nom et une
	adresse électronique), ce qui peut permettre à un correspondant
	réseau de retrouver l'utilisateur principal d'un PC s'il
	renseigne cette information~;

    \item contient un \textbf {commentaire}, qui peut typiquement
	être une référence à une prise, à un équipement, à un local,
	etc.~;

    \item
	est associé éventuellement à une \textbf {adresse MAC} et
	à un \textbf {profil DHCP}. Ces informations permettent de
	générer des allocations statiques avec DHCP.

    \cbstart%1.5
    \item dipose d'un \textbf {TTL} (exprimé en secondes), qui sera
	le plus souvent égal à -1 pour signifier que le TTL par
	défaut de la zone s'applique.

    \item a éventuellement le \textbf {droit d'émettre en SMTP non
	authentifié}.
    \cbend%1.5

    \item contient la référence du \textbf {dernier correspondant} ayant
	modifié le RR, ainsi que la \textbf {date}.

\end {itemize}

Il faut insister sur le fait qu'un nom de RR ne comporte pas de
point.  Ainsi, vous ne pouvez pas ajouter «~www.labo~» dans le
domaine «~domaine.fr~», par exemple. Pour cela, il faut créer le
domaine «~labo.domaine.fr~» et y rentrer le RR de nom «~www~»
(ou alors gérer ceci comme une exception à l'aide du \textit
{prologue} de la zone, comme décrit ci-après).

À un RR sont rattachées différentes informations~: une ou plusieurs
\textbf {adresses IP} (v4 aussi bien que v6), un ou plusieurs \textbf
{aliases}, des \textbf {rôles de messagerie} ou des \textbf {MX}.

Il faut noter que l'adresse MAC est associée à un nom, et non à une
adresse IP. Ce choix a été dicté par la simplicité d'implémentation
et par l'ergonomie générale de WebDNS. Le cas de machines ayant
plusieurs adresses IP et utilisant cependant DHCP a paru suffisamment
rare pour relever de cas particulier et ne pas être pris en compte
par cette interface.


\titreB {Droits sur les adresses IP et les noms}

En premier lieu, un groupe a accès à un ou plusieurs domaines (via
la table \texttt {dr\_dom}). À chaque domaine est associé une classe
de tri, de façon que le groupe puisse voir en premier les domaines qui
le concernent. Si un seul domaine est défini pour un groupe, ses
membres ne verront qu'un champ fixe au lieu d'un menu déroulant.

En second lieu, un groupe a accès à des plages d'adresses IP (IPv4
ou IPv6, via la table \texttt {dr\_ip}). Une plage d'adresses IP
est définie comme une suite de droits de type «~\texttt {allow}~»
ou «~\texttt {deny}~» sur des préfixes IP. Ainsi, pour permettre
aux membres d'un groupe de déclarer des machines dans toute une
plage d'adresses, sauf l'adresse de \textit {broadcast} et l'adresse
du routeur (définie par exemple comme la dernière adresse du réseau),
on déclarera les deux plages~:

\begin {itemize}
    \item \textit {allow} \texttt {192.168.1.0/24}
    \item \textit {deny} \texttt {192.168.1.254/31}
\end {itemize}

Un correspondant peut donc déclarer des machines si les deux conditions
sont réunies~:

\begin {itemize}
    \item l'adresse fait partie des plages autorisées
    \item le domaine fait partie des domaines autorisés
\end {itemize}

Dans le cas d'une machine déclarée avec plusieurs adresses (comme
un routeur, par exemple), un correspondant peut y accéder (ajouter
ou supprimer une adresse, modifier un attribut, ajouter un alias,
etc.) si et seulement si toutes les adresses IP sont dans les plages
du correspondant.


\titreB {Les zones}

Les «~zones~» ne doivent pas être confondues avec les «~domaines~»~:
si les «~domaines~» regroupent des RR dans la base, les «~zones~»
quant à elles contiennent les renseignements nécessaires pour générer
les fichiers de zone sur votre serveur DNS.

Les zones comprennent entre autres~:

\begin {itemize}
    \item le \textbf {nom de la zone} («~\texttt {u-strasbg.fr}~»,
	ou «~\texttt {79.130.in-addr.arpa}~» par exemple)~;

    \item le \textbf {critère} servant, lors de la génération, à sélectionner
	les informations dans la base~:

	\begin {itemize}
	    \item pour une zone «~inverse~» (dans \texttt
		{in-addr.arpa} ou \texttt {ip6.arpa}), il s'agit
		d'un préfixe de réseau (par exemple \texttt
		{130.79.201.128/25}),

	    \item pour une zone «~normale~», il s'agit du domaine
		associé à chaque nom (\texttt {u-strasbg.fr} pour
		sélectionner les RR devant figurer dans la zone \texttt
		{u-strasbg.fr})~;
	\end {itemize}

    \item
	\label {version-soa}
	le \textbf {numéro de version} qui devra être inséré dans le SOA. Ce
	numéro de version est toujours de la forme AAAAMMJJnn, où
	AAAA est l'année, MM le mois, JJ le jour et nn le numéro
	de modification dans la journée (limité à 99, donc)~;

    \item le \textbf {prologue}, ensemble de commentaires et de RR, qui
	figurera avant les RR générés dans la zone. En particulier, le
	prologue contient le RR de type SOA, ainsi que les RR de type NS
	ou MX associés au domaine lui-même~;

    \item des \textbf {RR supplémentaires} à insérer pour chaque RR de
	type A ou AAAA. Il s'agit d'une chaîne de caractères (sur
	plusieurs lignes éventuellement si vous avez plusieurs RR
	à ajouter) dans laquelle toutes les occurrences de la chaîne
	«~\texttt {\%NOM\%}~» sont substituées par le nom du RR
	de type A ou AAAA. Pour l'utilisation de ce champ, voir~\ref
	{anx-rrsup} (page~\pageref {anx-rrsup})~;

    \item et enfin, un \textbf {indicateur} servant à indiquer si la zone doit
	être regénérée sur le serveur DNS, c'est à dire si au moins
	un RR de la zone a été modifié.
\end {itemize}

Le script de génération de zone (\texttt {generer-zone}, voir~\ref
{generer-zone}, page~\pageref {generer-zone}) calcule un nouveau
numéro de version à partir de celui qui figure dans la base, puis
il extrait le prologue, y recherche la chaîne «~\texttt {\%VERSION\%}~»
et la substitue par le nouveau numéro de version calculé précédemment,
et enfin génère les RR associés à la zone en les sélectionnant à
partir du critère, et en y ajoutant éventuellement les RR supplémentaires
associés à la zone.

Le prologue ne contient habituellement que les informations liées
à la zone elle-même, soit les RR de type SOA, NS et MX associés au
domaine. Dans la pratique, le prologue peut également contenir tous
les cas particuliers\footnote {Certains diront les «~scories de
l'histoire d'un site~».} qui ne peuvent être pris en compte dans
le modèle.


\titreB {MX et rôles de messagerie}

Le DNS est souvent utilisé pour implanter une politique de messagerie,
par le biais des RR de type MX.

Alors que les autres parties du modèle sont assez génériques, la
gestion des informations de politique de messagerie n'a pas fait
l'objet d'une étude de généricité aussi poussée. L'expérience
d'autres sites permettra sans doute d'adapter le modèle décrit
ci-dessous.

Les auteurs ont conçu la gestion de la messagerie en supposant un
routage centralisé par domaine (avec par exemple un filtrage sur
le port SMTP en entrée de site), bien que cette restriction puisse
souffrir des exceptions.


\titreC {Utilisation des RR supplémentaires}
    \label {anx-rrsup}

Une première méthode de gestion des MX consiste à associer un ou
plusieurs MX standards à toute adresse IP (v4 ou v6).

Cette méthode était utilisée jusqu'en avril 2004 sur Osiris. Elle
a prouvé ses limites, notamment parce qu'elle publie toute adresse
de machine comme adresse utilisable.

Néanmoins, si vous souhaitez l'utiliser, il suffit d'activer les
RR supplémentaires pour la ou les zones correspondantes. Par exemple,
sur Osiris, nous utilisions~:

\begin {quote}
\small
\begin {verbatim}
%NOM%	IN	MX	10 ns1.u-strasbg.fr.
%NOM%	IN	MX	10 ns2.u-strasbg.fr.
\end{verbatim}
\end {quote}

Ainsi, après tout RR de type A ou AAAA, le script de génération de
zone (\texttt {generer-zone}, voir~\ref {generer-zone}, page~\pageref
{generer-zone}) ajoute le texte ci-dessus en remplaçant la chaîne
«~\texttt {\%NOM\%} par le nom du RR de type A ou AAAA.

Afin de permettre de créer des RR de type MX qui ne sont pas associés
à des adresses IP (comme par exemple pour des adresses de messagerie
virtuelles), l'application WebDNS permet de renseigner la table des
MX. Celle-ci associe à un RR, c'est-à-dire à un nom~:

\begin {itemize}
    \item une \textbf {priorité}~;
    \item un \textbf {autre RR}, qui sera le RR pointé par le MX.
\end {itemize}

Il est bien sûr possible de déclarer plusieurs MX pour un nom
donné.

Cette possibilité est restreinte aux administrateurs de l'application.
Elle permet de gérer des cas particuliers à la règle «~une adresse,
un MX~», comme notamment les adresses virtuelles de messagerie.


\titreC {Utilisation des rôles de messagerie}
    \label {anx-rolemail}

La deuxième méthode de gestion des MX s'appelle les «~rôles de
messagerie~». Elle est nettement plus souple, car elle permet aux
correspondant autorisés de gérer eux-mêmes, de manière contrôlée,
les adresses de messagerie.

L'utilisation des rôles de messagerie passe par~:

\begin {itemize}
    \item l'affectation du droit correspondant à la gestion des
	domaines de messagerie au groupe, pour chacun des domaines
	autorisés (menu de modification des caractéristiques d'un
	groupe dans l'application, table \texttt {dr\_dom})~;

    \item l'affectation d'un ou plusieurs relais pour le domaine
	(menu de modification des relais de messagerie dans
	l'applcation, table \texttt {relais\_dom})~;

\end {itemize}

Fonctionnellement, un correspondant dont le groupe a le droit de
gérer les rôles de messagerie pour un domaine particulier peut
associer à une \textbf {adresse de messagerie} (qui peut correspondre
ou non à une adresse IP existante) une machine réalisant l'\textbf
{hébergement} des boîtes aux lettres pour cette adresse.

Le script de génération de zone (\texttt {generer-zone}, voir~\ref
{generer-zone}, page~\pageref {generer-zone}) générera, pour chaque
rôle de messagerie déclaré par un correspondant, un MX par relais
enregistré pour le domaine. Ainsi, les correspondants autorisés
peuvent définir eux-mêmes les adresses de messagerie qu'ils gèrent,
tout en respectant le filtrage sur le port SMTP en entrée.

Bien sûr, pour que ceci soit pleinement opérationnel, il faut que
le ou les relais de messagerie actualisent leur table de routage
de messagerie.  En utilisant le script \texttt {generer-routages}
(voir~\ref {generer-routages}, page~\pageref {generer-routages}),
vous pouvez créer dynamiquement une table de routage pour \texttt
{sendmail} telle que l'attend le kit Jussieu par exemple.


\titreB {Gestion DHCP}

La gestion DHCP est intimement liée au DNS. Elle ne concerne que
les adresses IPv4 pour le moment.

\titreC {Configuration d'un réseau}

Pour que la génération d'associations DHCP puisse se faire, il faut
qu'un réseau donné ait l'attribut \textbf {dhcp} associé à 1, ainsi
que l'\textbf {adresse IPv4} du routeur par défaut.


\titreC {Association statique}

La génération d'allocations statiques (adresse IP, adresse MAC)
repose sur l'attribut \textbf {dhcp} du réseau, mais également sur
la présence d'une adresse MAC.

Si un profil DHCP est défini pour le RR considéré, l'association
statique est placée dans un «~\textit {groupe}~» (au sens du
serveur ISC).


\titreC {Profils DHCP}

L'application laisse à l'administrateur la possibilité de définir
des profils DHCP, constitués d'un \textbf {nom} (unique) et d'un
\textbf {texte}, consituté d'options du serveur DHCP.

Ces profils doivent ensuite être associés à un groupe de correspondants
pour pouvoir être rendus \textit {visibles}, par l'intermédiaire
de la table \texttt {dr\_dhcpprofil}. Cette visibilité n'est cependant
pas exclusive~: l'attribut ne sert qu'à restreindre l'apparition
des profils dans les menus (avec un critère de \textbf {tri}), mais
n'empêche nullement un correspondant de falsifier un champ de
formulaire pour insérer un autre profil~; les profils ne sont en
effet pas considérés comme une ressource confidentielle et critique.


\titreC {Intervalles dynamiques}

Les droits associés à un groupe (en plus de la visibilité de profils
DHCP comme vu dans la section précédente) sont la possibilité de
configurer des intervalles DHCP dynamiques, via le champ \textbf
{dhcp} de la table \texttt {dr\_reseau}.

Pour pouvoir configurer un intervalle dynamique, un correspondant
réseau doit avoir l'accessibilité sur \textit {toutes} les adresses
entre l'adresse \textbf {min} et l'adresse \textbf {max}. L'intervalle
est associé à un \textbf {domaine} par défaut,
\cbstart%1.5
un \textbf {profil DHCP} éventuel,
\cbend%1.5
ainsi que des
paramètres spécifiques (\textbf {default\_lease\_time} et \textbf
{max\_lease\_time}) qui sont transmis au serveur DHCP et ne peuvent
être hors de l'intervalle défini par les paramètres de configuration
globaux (\textbf {min\_lease\_time} et \textbf {max\_lease\_time},
accessible via l'interface d'\textit {administration des paramètres
de configuration}).


\titreC {Indicateur de génération}

La table \texttt {dhcp} ne contient qu'une seule valeur (une seule
colonne et une seule ligne), qui vaut soit 0 soit 1. Un \textit
{trigger} permet de passer cette valeur à 1 lorsqu'une adresse MAC
est modifiée et que la configuration DHCP doit être regénérée.

L'utilitaire de génération remet la valeur à 0 en fin d'exécution.


\titreB {Tables non utilisées}

Quelques unes des tables existant dans la base sont prévues pour un
usage futur~:

\begin {itemize}
    \item la table \texttt {role\_web} ainsi que l'attribut \textbf
	{roleweb} de la table \texttt {dr\_dom} sont prévus pour
	permettre aux correspondants de déclarer les serveurs Web
	autorisés dans leur domaine. Au delà de l'identification
	de la responsabilité éditoriale, ceci permettra dans le
	futur de générer des filtres sur les routeurs~;

    \item la table \texttt {dr\_mbox} est prévue pour une gestion
	plus intégrée de l'hébergement de boîtes aux lettres sur
	un serveur de messagerie multi-domaines. L'idée est d'associer
	un groupe à une adresse de messagerie, afin de lui déléguer la
	gestion des boîtes aux lettres correspondantes.

\end {itemize}


\titreB {Procédures}

Une bonne connaissance du modèle des données permet de déduire
toutes les procédures.

\titreC {Ajouter ou supprimer un correspondant}

Pour ajouter un correspondant, il faut au préalable que le groupe
existe.

Si ce n'est pas le cas, il faut utiliser~:

\begin {itemize}
    \item d'abord le menu de \textit {modification des groupes},
	pour créer le groupe~;

    \item ensuite le menu de \textit {modification des caractéristiques
	d'un groupe} pour lui affecter des droits sur les réseaux
	consultables, sur les domaines et les plages autorisés.

\end {itemize}

Il ne reste plus ensuite qu'à ajouter le correspondant au moyen du
menu de \textit {gestion des correspondants}. Ceci a pour effet
d'ajouter le correspondant à la base d'authentification (WebAuth)
pour l'accès au serveur Web, ainsi que dans la base WebDNS pour
l'affectation à un groupe.

Pour supprimer un correspondant, il faut utiliser le menu de \textit
{gestion des correspondants}. La suppression échouera sur une
contrainte d'intégrité de la base si le correspondant a modifié des
RR. Dans ce cas, il ne faut pas supprimer le correspondant, mais
le rendre «~absent~» (i.e. non présent) par le menu de \textit
{modification d'un correspondant}.


\titreC {Ajouter un réseau}

Pour ajouter ou supprimer un réseau, il faut passer par le menu de
\textit {modification des réseaux}. Une fois le réseau créé, il
faut le rendre accessible (en consultation et par les plages
d'adresses) par tous les groupes concernés, par l'intermédiaire du
menu de \textit {modification des caractéristiques d'un groupe}.

Éventuellement, il faut créer une zone inverse pour le réseau sur
le serveur DNS, et créer la zone avec le menu de \textit {modification
des zones reverse IPv4} (ou IPv6).


\titreC {Ajouter un domaine}

L'ajout d'un domaine nécessite~:

\begin {itemize}
    \item d'ajouter le domaine par le menu de \textit {modification
	des domaines}~;

    \item d'ajouter les droits sur le domaine à tous les groupes
	concernés, par l'intermédiaire du menu de \textit {modification
	des caractéristiques des groupes}~;

    \item d'ajouter la zone correspondante sur le serveur DNS~;

    \item d'ajouter la zone dans la base par le menu de \textit
	{modification des zones}.

\end {itemize}

La suppression d'un domaine nécessite les opérations inverses. En
cas de violation d'une contrainte d'intégrité, la modification
correspondante sera annulée.

\titreC {Configurer un terminal X par DHCP}

Cette procédure est complexe, car elle met en {\oe}uvre beaucoup
de mécanismes. On suppose que vous voulez permettre à un correspondant
réseau de saisir une association pour un terminal X avec des options
DHCP particulières (pour le serveur de boot, par exemple)..

Il faut donc~:

\begin {itemize}
    \item vérifier que le réseau a bien la capacité d'utiliser DHCP,
	en se rendant dans le menu de \textit {modification des réseaux}
	(regarder en particulier les colonnes «~Passerelle IPv4~» et
	«~DHCP activé~»)~;

    \item vérifier sur le routeur concerné que le relayage DHCP est
	activé~;

    \item définir le nouveau profil DHCP. Pour cela, se rendre dans
	le menu de \textit {modification des profils DHCP} dans la
	page d'administration, et saisir le nom du profil, et les
	options DHCP que vous souhaitez~;

    \item par l'intermédiaire du menu de \textit {modification des
	caractéristiques des groupes}, vérifier d'une part que le
	groupe du correspondant réseau a accès à la gestion DHCP
	(case «~Accès à la gestion DHCP~» dans la partie «~Réseaux
	autorisés~»), et lui associer d'autre part le profil DHCP
	(partie «~Profils DHCP visibles~»).

\end {itemize}

Une fois ces modifications effectuées, le correspondant réseau peut
saisir l'adresse MAC et le profil que vous aurez définis. Il verra
également le texte du profil DHCP s'il consulte ses droits.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%}}
% Annexe - Migration vers la version courante
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\clearpage
\titreA {Release notes}

\cbstart%1.5
\titreB {Version 1.5}

Hormis l'ajout de la notion de «~droit d'émettre en SMTP non
authentifié~» utilisé pour verrouiller au maximum l'utilisation de
SMTP non authentifié sur un domaine, les principales modifications
introduites dans la version 1.5 de WebDNS ont pour objet une meilleure
ergonomie.

\titreC {Changements apparus dans la version 1.5}

L'ajout du «~droit d'émettre en SMTP non authentifié~» est matérialisé
par une case à cocher supplémentaire dans les attributs d'un groupe
de correspondants (cf menu «~Modifier les groupes et les
correspondants~»). Si le groupe est autorisé, les pages d'ajout et
de modification de machine sont modifiées pour ajouter une case
«~Émettre en SMTP~». Cocher cette case impose une confirmation
formelle de la part du correspondant réseau.

Les profils DHCP ont également connu quelques modifications~:
\begin {itemize}
    \item le profil DHCP est dorénavant un paramètre des plages
	DHCP dynamiques et non plus seulement un paramètre des
	associations statiques

    \item l'affectation d'un profil DHCP sur une machine sans adresse
	MAC (c'est à dire sans association DHCP statique) est
	maintenant refusée, car cela n'a aucun sens. La procédure
	de mise à jour de la base supprime d'ailleurs tous les
	profils DHCP des machines sans adresse MAC.

    \item le profil DHCP est maintenant affiché dans la liste des
	machines d'un réseau (page de consultation). Cette nouvelle
	colonne est également présente dans le fichier PDF généré
	pour l'impression.

\end {itemize}

Il est maintenant possible de renommer (nom et domaine) une machine
depuis la page de modification des informations d'une machine. Par
ailleurs, le changement d'adresse IP, souvent demandé, peut être
facilement réalisé avec une astuce (ajout de la nouvelle adresse,
puis suppression de l'ancienne) qui est rappelée dans cette page.

Les TTL (Time To Live) des RR DNS peuvent être paramétrés. Pour
cela, un nouveau droit est associé à chaque groupe de correspondants
(accessible par la page d'édition des groupes). Si ce droit est
activé, un nouveau champ est visible dans les pages d'ajout et de
modification de machine. Ce champ est pris en compte dans la
génération de zones sur le serveur DNS.

Une «~carte des adresses~» (IPv4 seulement, pour des raisons
évidentes) est maintenant disponible. Elle est accessible depuis
la page de consultation des réseaux (bouton «~carte des adresses~»)
et depuis la page d'ajout de machine (section «~Recherche de plusieurs
adresses IPv4 disponibles~», puis bouton «~Consulter la carte~»).
Cette carte présente l'ensemble de l'espace d'adressage
pour repérer les adresses disponibles (i.e. non déclarées et
ne figurant pas dans un intervalle DHCP dynamique). À partir de là~:

\begin {itemize}
    \item  cliquer sur une adresse non déclarée permet de déclarer
	une machine
    \item cliquer sur une adresse déclarée permet d'éditer les
	informations (nom, type de machine, adresse MAC, etc.) ou
	de supprimer la machine. Cette fonctionnalité est également
	accessible dans la liste des machines d'un sous-réseau.
\end {itemize}

Il est également possible de rechercher automatiquement un bloc
d'adresses IPv4 consécutives disponibles, et de procéder à l'ajout
des machines correspondantes. Depuis la page d'ajout de machine,
dans la section ~Recherche de plusieurs adresses IPv4 disponibles~»,
il suffit d'indiquer le réseau et le nombre d'adresses souhaité
pour commencer à saisir les machines.

Une nouvelle fonctionnalité, «~où suis-je~?~», affiche l'adresse
IP du navigateur Web. Si l'adresse est dans un des réseaux gérés
avec WebDNS, les responsables du réseau sont affichés. Si l'adresse
correspond de plus à un nom, le RR correspondant est affiché. Ceci
a pour but de permettre à un administrateur d'identifier la machine
à partir de laquelle il se connecte (par exemple depuis une salle
de ressources ou depuis une borne interactive).

Le source (en langage C) de HTG utilisait des caractéristiques
datant des versions de Tcl 7.x, et toujours supportées jusqu'à la
version 8.5 de Tcl. La version 8.6 de Tcl, actuellement en version
bêta, arrête le support de ces anciennes caractéristiques. Le source
de HTG a donc été changé, et le fonctionnement validé tant avec Tcl
8.5 qu'avec 8.6.

Enfin, les titres de pages ont été explicités, notamment pour se
repérer plus facilement dans les menus d'historique de la plupart
des navigateurs.

\titreC {Migration de la version 1.4 vers la version 1.5}
    \label {upgr14-15}

La migration de la version 1.4 vers la version 1.5 nécessite
des modifications de la base.
Pour cela, suivez les étapes ci-après~:

\begin {enumerate}
    \item \textbf {Arrêt de l'application}

	Commencez par interdire aux utilisateur l'accès à l'application
	en mettant en message dans le fichier défini par la variable
	\texttt {NOLOGIN} (voir~\ref {install-dns}, page~\pageref
	{install-dns}) sur le serveur Web. À ce stade, seuls les
	utilisateurs définis par la variabble \texttt {ROOT} sont
	habilités à utiliser l'application.

    \item \textbf {Sauvegarde}

	Sauvegardez la base~:

	\begin {quote}
	    \verb|pg_dump dns > /tmp/dns.dump|
	\end {quote}

    \item \textbf {Modification de la base}

	Rendez-vous dans le répertoire de migration \verb|./upgrade/14-15/|
	sur le serveur de données, et exécutez la commande~:

	\begin {quote}
	    \verb|psql -f upgrade.sql dns|
	\end {quote}

    \item \textbf {Installation de la nouvelle application}

	Installez les fichiers de l'application Web, tels que définis
	en~\ref {install-dns} (page~\pageref {install-dns}), en
	prenant soin d'adapter les pages à trous si vous en éprouvez
	le besoin.

    \item \textbf {Installation des autres fichiers}

	Reprenez les scripts de génération des zones, des routages de
	messagerie, et de génération DHCP.

    \item \textbf {Redémarrage}

	Supprimez le fichier défini par la variable \texttt {NOLOGIN}
	pour autoriser les utilisateurs à accéder de nouveau à
	l'application.

\end {enumerate}

\cbend%1.5


\titreB {Version 1.4}

La principale innovation de la version 1.4 de WebDNS est la séparation
du schéma d'authentification jusque là bâti sur WebAuth et une base
PostgreSQL.


\titreC {Changements apparus dans la version 1.4}

Le couplage entre WebDNS et la base d'authentification est maintenant
beaucoup plus lâche. Cela se traduit par~:

\begin {itemize}
    \item l'ajout d'un mode LDAP pour obtenir des informations
	sur l'identité d'un utilisateur~;

    \item la suppression des liens directs dans WebDNS pour gérer
	les utilisateurs (création, suppression, etc.), ainsi que
	pour le changement de mot de passe~;

    \item la refonte de l'interface de gestion des utilisateurs~:
	celle-ci suppose que les utilisateurs sont déjà créés dans
	la base d'authentification externe (LDAP ou PostgreSQL via
	WebAuth), et WebDNS ne fait plus qu'associer des logins à
	des groupes~;

    \item le changement de mot de passe figure juste comme un lien
	vers une application externe (la vôtre, dans le cas LDAP,
	ou WebAuth).

    \item l'application WebAuth est maintenant fournie dans la
	distribution de WebDNS (et non plus séparée comme auparavant).

\end {itemize}

Les autres changements de la version 1.4 par rapport à la version
précédente sont~:

\begin {itemize}
    \item correction de bugs~:
	\begin {itemize}
	    \item lors de l'édition des plages DHCP, les valeurs par
		défaut n'étaient pas prises en compte,
	    \item suppression d'une erreur de syntaxe dans une
		portion de code très rarement utilisée du script
		\texttt {traiteajout},
	    \item il y avait un cas non traité dans la vérification
		des droits, lors de l'ajout d'un alias sur une
		machine qui n'existe pas~;
	\end {itemize}

    \item inversion des bandeaux de gauche «~voir aussi~» et
	«~actions~»~;

    \item plusieurs scripts sont maintenant accessibles à tous (et plus
	seulement aux administrateurs)~:
	\begin {itemize}
	    \item liste des correspondants,
	    \item liste des réseaux~: ce dernier script n'est
		toutefois pas accessible aux utilisateurs «~normaux~»
		qui ne connaissent pas son URL~;
	\end {itemize}

    \item lors de l'affichage du ou des correspondants associés à
	une machine, lister les correspondants non administrateurs en
	premier (les administrateurs ayant le plus souvent les
	droits sur tous les réseaux, ils sont toujours listés)~;

    \item explicitation du message d'erreur en cas d'ajout sur un
	alias~;

    \item paramétrisation de la couleur du fond des boutons
	«~valider~»~;

    \item journalisation des actions dans la table «~log~» de WebDNS.
	Cette table est pour l'instant seulement remplie. Elle n'est
	jamais vidée, ni consultée~;

    \item si le responsable d'une machine n'est pas précisé, lors de
	l'ajout ou de la modification, inscrire par défaut le
	correspondant réalisant l'action~;

    \item plus de support de la version 7 de PostgreSQL. WebDNS
	nécessite au minimum la version 8.0.

\end {itemize}


\titreC {Migration de la version 1.3 vers la version 1.4}
    \label {upgr13-14}

La migration de la version 1.3 vers la version 1.4 nécessite une
légère modification de la base pour y ajouter la table «~log~».
Pour cela, suivez les étapes ci-après~:

\begin {enumerate}
    \item \textbf {Arrêt de l'application}

	Commencez par interdire aux utilisateur l'accès à l'application
	en mettant en message dans le fichier défini par la variable
	\texttt {NOLOGIN} (voir~\ref {install-dns}, page~\pageref
	{install-dns}) sur le serveur Web. À ce stade, seuls les
	utilisateurs définis par la variabble \texttt {ROOT} sont
	habilités à utiliser l'application.

    \item \textbf {Sauvegarde}

	Sauvegardez la base~:

	\begin {quote}
	    \verb|pg_dump dns > /tmp/dns.dump|
	\end {quote}

    \item \textbf {Modification de la base}

	Rendez-vous dans le répertoire de migration \verb|./upgrade/13-14/|
	sur le serveur de données. Éditez le fichier \texttt
	{upgrade.sql} et modifiez y les directives \texttt {GRANT}
	pour les adapter aux utilisateurs actifs (les utilisateurs
	de PostgreSQL, pas les utilisateurs de l'application).
	Lorsque vous avez fini, vous pouvez exécuter la commande~:

	\begin {quote}
	    \verb|psql -f upgrade.sql dns|
	\end {quote}

    \item \textbf {Installation de la nouvelle application}

	Installez les fichiers de l'application Web, tels que définis
	en~\ref {install-dns} (page~\pageref {install-dns}), en
	prenant soin d'adapter les pages à trous si vous en éprouvez
	le besoin.

	Notez que le nouveau modèle conseillé est le modèle \texttt
	{webdns}, incluant une feuille de style CSS et des images
	associées. Il faudra donc les installer dans votre arborescence
	Web comme indiqué en~\ref {htg-webdns} (page~\pageref
	{htg-webdns}).

    \item \textbf {Installation des autres fichiers}

	Reprenez les scripts de génération des zones, des routages de
	messagerie, et de génération DHCP.

    \item \textbf {Redémarrage}

	Supprimez le fichier défini par la variable \texttt {NOLOGIN}
	pour autoriser les utilisateurs à accéder de nouveau à
	l'application.

\end {enumerate}


\titreB {Version 1.3}

La version 1.3 de l'application représente un pas supplémentaire
vers l'utilisation de la base DNS pour d'autres applications que
la simple gestion du DNS. Le support de DHCP, très demandé par les
utilisateurs, est la principale innovation de cette version.

\titreC {Changements apparus dans la version 1.3}

Les changements de la version 1.3 par rapport à la version
précédente sont~:

\begin {itemize}
    \item correction d'un bug affectant la génération des zones
	lorsqu'une adresse IPv6 était mal saisie (avec un «~/64~»
	à la fin par exemple). Ce type d'adresse est maintenant
	interdit à la saisie. Patch diffusé dans la liste webdns
	le 28 octobre 2004.

    \item correction d'un bug affectant la recherche d'un correspondant
	à partir d'un nom qui n'est qu'un rôle de messagerie. Patch
	diffusé dans la liste webdns le 24 février 2005.

    \item correction d'un bug dans le package \texttt {webapp.tcl}
	de génération HTML.

    \item correction de méthodes de formulaires HTML qui étaient
	en méthode GET au lieu d'être en POST.

    \item changement du format interne des dates de dernière
	modification associées à chaque RR. C'était auparavant un
	nombre de secondes (format \texttt {time\_t} d'Unix). C'est
	maintenant une date au format SQL, plus facile à manipuler.

    \item affichage du numéro de version de WebDNS dans le bandeau
	de chaque page.

    \item création d'un script de sauvegarde horaire, compte-tenu de la
	sensibilité des données hébergées par WebDNS.

    \item création d'utilitaires auxiliaires pour réaliser des
	opérations sans passer par l'interface Web~:

	\begin {itemize}
	    \item ajouter une machine (nom + adresse IP)~;
	    \item ajouter un alias~;
	    \item supprimer une machine ou un alias~;
	    \item supprimer une adresse IP~;
	    \item modifier les autres attributs (adresse MAC, profil
		DHCP, commentaire, etc.) d'un RR~;
	    \item lire le prologue d'une zone et l'afficher sur la
		sortie standard~;
	    \item modifier le prologue d'une zone à partir d'un
		fichier~;
	\end {itemize}

	Les deux derniers utilitaires ont été envoyés, dans une version
	«~shell~» sur la liste WebDNS le 25 mai 2004. Ils ont été
	réécrits en Tcl pour bénéficier de la substitution automatique
	des variables opérée par le \texttt {Makefile} de l'application
	Web.

    \item ajout de la fonctionnalité DHCP~:

	\begin {itemize}
	    \item activation DHCP réseau par réseau~;

	    \item gestion et délégation des allocations statiques
		(adresse MAC / nom)~;

	    \item accès aux profils DHCP et à la gestion des
		intervalles d'allocation dynamique, groupe de
		correspondants par groupe de correspondants.

	\end {itemize}

    \item ajout du droit ACL~: ce droit est réservé à une utilisation
	future.

\end {itemize}


\titreC {Migration de la version 1.2 vers la version 1.3}
    \label {upgr12-13}

La migration de la version 1.2 vers la version 1.3 nécessite une
modification en profondeur de la base. Pour cela, suivez les étapes
ci-après~:

\begin {enumerate}
    \item \textbf {Arrêt de l'application}

	Commencez par interdire aux utilisateur l'accès à l'application
	en mettant en message dans le fichier défini par la variable
	\texttt {NOLOGIN} (voir~\ref {install-dns}, page~\pageref
	{install-dns}) sur le serveur Web. À ce stade, seuls les
	utilisateurs définis par la variabble \texttt {ROOT} sont
	habilités à utiliser l'application.

    \item \textbf {Sauvegarde}

	Sauvegardez la base~:

	\begin {quote}
	    \verb|pg_dump dns > /tmp/dns.dump|
	\end {quote}

    \item \textbf {Installation du langage pltcl}

	Le langage Pl/Tcl doit être installé dans le moteur PostgreSQL.
	Sur le serveur de données, faites~:

	\begin {quote}
	    \verb|createlang pltcl dns|
	\end {quote}

    \item \textbf {Migration de la base}

	Rendez-vous dans le répertoire de migration \verb|./upgrade/12-13/|
	sur le serveur de données. Éditez le fichier \texttt
	{upgrade.sql} et modifiez y les directives \texttt {GRANT}
	pour les adapter aux utilisateurs actifs (les utilisateurs
	de PostgreSQL, pas les utilisateurs de l'application).
	Lorsque vous avez fini, vous pouvez exécuter la commande~:

	\begin {quote}
	    \verb|psql -f upgrade.sql dns|
	\end {quote}

    \item \textbf {Installation de la nouvelle application}

	Installez les fichiers de l'application Web, tels que définis
	en~\ref {install-dns} (page~\pageref {install-dns}), en
	prenant soin d'adapter les pages à trous si vous en éprouvez
	le besoin.

	Attention~: le package \verb|./pkgtcl/webapp.tcl| a été changé.

    \item \textbf {Installation des autres fichiers}

	Reprenez les scripts de génération des zones, des routages de
	messagerie.

	Installez également, si vous le souhaitez, les scripts de
	génération DHCP.

    \item \textbf {Redémarrage}

	Supprimez le fichier défini par la variable \texttt {NOLOGIN}
	pour autoriser les utilisateurs à accéder de nouveau à
	l'application.

\end {enumerate}

\cbdelete%1.5
% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%}}
% % Annexe - Contributions
% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% 
% \clearpage
% \titreA {Contributions}
%     \label {contrib}
% 
% L'application WebDNS suscite des contributions qui peuvent intéresser
% la communauté des utilisateurs, via la liste \texttt
% {webdns@u-strasbg.fr}
% 
% Ces contributions sont décrites dans cette documentation pour
% faciliter votre information. Elles n'engagement pas les auteurs de
% WebDNS, qui n'assurent en outre bien évidemment pas leur support.
% 
% 
% \cbdelete%1.5
% \titreB {Canal pour Esup-Portail}
% 
% Cette contribution provient de Philippe Martin (\texttt {philippe.martin
% at univ-pau.fr}) du CRI de l'Université de Pau et des Pays de
% l'Adour.
% 
% L'université ayant mis en place le portail Esup\footnote {\htmlurl
% {http://www.esup-portail.org}}, le CRI a développé un canal pour
% ce portail. Il permet aux correspondants d'effectuer, pour les
% plages qui les concernent, les opérations d'ajout et modification
% d'adresse.
% 
% Les fonctionnalités accessibles par ce canal concernent uniquement
% les correspondants~:
% 
% \begin {itemize}
%     \item consultation de la liste des réseaux autorisés~;
%     \item consultation de la liste des machines dans un des réseaux
% 	autorisés~;
%     \item ajout d'une machine (nom et adresse IPv4)~;
%     \item ajout d'une liste de machines (noms et adresses IPv4)~;
%     \item pour une machine autorisée, les possibilités offertes sont~:
% 	\begin {itemize}
% 	    \item supprimer la machine,
% 	    \item modifier les informations (système, commentaire, responsable, email),
% 	    \item modifier l'adresse IPv4,
% 	    \item ajouter une adresse IPv6,
% 	    \item modifier l'adresse IPv6,
% 	    \item supprimer l'adresse IPv6,
% 	    \item ajouter un alias,
% 	    \item supprimer un alias.
% 	\end {itemize}
% \end {itemize}
% 
% L'administration de l'application continue à se faire par l'application
% WebDNS elle-même.
% 
% Le canal est téléchargeable sur~:
% 	\htmlurl {ftp://ftp.univ-pau.fr/pub/ACO/canaux/}
% (disponible pour la version 1.2 de WebDNS à l'heure de mise sous
% presse).

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%}}
% Annexe - Pages à trous
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\clearpage
\titreA {Pages à trous}
    \label {anx-trous}

\titreB {Pages à trous de WebDNS}

{\small
    \tablehead {\hline
	\multicolumn {1} {|c|} {\textbf {Fichier}} &
		\multicolumn {1} {|c|} {\textbf {Trou}} &
		\multicolumn {1} {|c|} {\textbf {Signification}}
	\\ \hline
    }
    \tabletail {\hline}
\begin {supertabular} {|l|p{40mm}|p{80mm}|}
    (tous)
	& \texttt {\%HOMEURL\%}
	& adresse relative de la page d'accueil par rapport
	    à la racine du serveur Web
	\\ \cline {2-3}
	& \texttt {\%PASSWDURL\%}
	& adresse de la page de changement de mot de passe
	    accessible aux utilisateurs (soit WebAuth, soit
	    votre propre application)
	\\ \cline {2-3}
	& \texttt {\%VERSION\%}
	& numéro de version de l'application WebDNS
	\\ \hline
    (beaucoup)
	& \texttt {\%COULEUR\%}
	& couleur de la bande de fond des boutons de validation
	    dans les formulaires
	\\ \hline
    accueil.html
	& \texttt {\%ADMIN\%}
	& lien permettant d'aller vers le menu d'administration.
	    Seul et unique moyen de se rendre dans ce menu.
	\\ \cline {2-3}
	& \texttt {\%DOCDNS\%}
	& adresse d'une page publique (hors de l'application)
	    décrivant la documentation de votre service DNS.
	\\ \cline {2-3}
	& \texttt {\%INTERVALLE\%}
	& intervalle entre deux générations de zones sur le serveur
	    DNS.
	\\ \hline
    admgenliste.html
	& \texttt {\%ZONES\%}
	& liste de zones permettant les sélections multiples
	\\ \hline
    admgenset.html
	& \texttt {\%DOCDNS\%}
	& adresse d'une page publique (hors de l'application)
	    décrivant la documentation de votre service DNS.
	\\ \cline {2-3}
	& \texttt {\%INTERVALLE\%}
	& intervalle entre deux générations de zones sur le serveur
	    DNS.
	\\ \hline
    admgrpconfirm.html
	& \texttt {\%HIDDEN\%}
	& liste de paramètres cachés pour propager les informations
	    sélectionnées par l'utilisateur.
	\\ \cline {2-3}
	& \texttt {\%MESSAGE\%}
	& incohérences trouvées dans la demande de l'utilisateur
	\\ \cline {2-3}
	& \texttt {\%MSGACT\%}
	& message synthétisant les actions à effectuer sur le groupe
	\\ \hline
    admgrpconfsuppr.html
	& \texttt {\%HIDDEN\%}
	& liste de paramètres cachés pour propager les informations
	    sélectionnées par l'utilisateur.
	\\ \cline {2-3}
	& \texttt {\%ORGGRP\%}
	& nom du groupe original
	\\ \hline
    admgrpedit.html
	& \texttt {\%ADMIN\%}
	& bouton pour activer ou non le droit d'administrer
	    l'application
	\\ \cline {2-3}
	\cbstart%1.5
	& \texttt {\%DROITSMTP\%}
	& case à cocher pour le droit d'émettre en SMTP non authentifié
	\\ \cline {2-3}
	& \texttt {\%DROITTTL\%}
	& case à cocher pour le droit d'éditer le TTL d'une machine
	\cbend%1.5
	\\ \cline {2-3}
	& \texttt {\%LISTECOR\%}
	& liste des correspondants inscrits dans le groupe
	\\ \cline {2-3}
	& \texttt {\%LISTEDHCPPROFILS\%}
	& liste des profils DHCP visibles
	\\ \cline {2-3}
	& \texttt {\%LISTEDOMAINES\%}
	& tableau de domaines modifiables
	\\ \cline {2-3}
	& \texttt {\%LISTEDROITS\%}
	& tableau de droits allow/deny modifiables
	\\ \cline {2-3}
	& \texttt {\%LISTERESEAUX\%}
	& tableau de réseaux sélectionnables
	\\ \cline {2-3}
	& \texttt {\%MESSAGEGROUPE\%}
	& message pour aider à la saisie du nom du groupe
	\\ \cline {2-3}
	& \texttt {\%NEWGRP\%}
	& nom du groupe à créer ou nouveau nom du groupe en cas de
	    renommage
	\\ \cline {2-3}
	& \texttt {\%ORGGRP\%}
	& nom original du groupe
	\\ \cline {2-3}
	& \texttt {\%TITRE\%}
	& titre de la page (édition ou création)
	\\ \hline
    admgrpmodif.html
	& \texttt {\%NEWGRP\%}
	& nom du groupe modifié
	\\ \cline {2-3}
	& \texttt {\%TABCIDRHORSRESEAU\%}
	& liste des plages hors des réseaux sélectionnés
	\\ \cline {2-3}
	& \texttt {\%TABDHCPPROFILS\%}
	& liste des profils DHCP visibles
	\\ \cline {2-3}
	& \texttt {\%TABDOMAINES\%}
	& liste des domaines saisis
	\\ \cline {2-3}
	\cbstart%1.5
	& \texttt {\%TABDROITS\%}
	& tableau des attributs généraux du groupe (droits SMTP et TTL)
	\cbend%1.5
	\\ \cline {2-3}
	& \texttt {\%TABLOGINS\%}
	& liste des membres du groupe
	\\ \cline {2-3}
	& \texttt {\%TABRESEAUX\%}
	& liste des réseaux sélectionnés
	\\ \hline
    admgrpsel.html
	& \texttt {\%MENUORGGRP\%}
	& menu de sélection du groupe à modifier
	\\ \hline
    admgrpsupprok.html
	& \texttt {\%ORGGRP\%}
	& nom du groupe à supprimer
	\\ \hline
    admmxedit.html
	& \texttt {\%DOMAINE\%}
	& domaine sélectionné
	\\ \cline {2-3}
	& \texttt {\%NOM\%}
	& nom du MX sélectionné
	\\ \cline {2-3}
	& \texttt {\%TABLEAU\%}
	& tableau des MX trouvés, éditable
	\\ \hline
    admmxmodif.html
	& \texttt {\%DOMAINE\%}
	& domaine sélectionné
	\\ \cline {2-3}
	& \texttt {\%NOM\%}
	& nom sélectionné
	\\ \cline {2-3}
	& \texttt {\%TABLEAU\%}
	& liste des MX modifiés
	\\ \hline
    admmxsel.html
	& \texttt {\%DOMAINE\%}
	& menu des domaines autorisés
	\\ \hline
    \cbstart%1.5
    admparhelp.html
	& \texttt {\%TEXTE\%}
	& texte de l'aide en ligne des paramètres de l'application
	\cbend%1.5
	\\ \hline
    admparliste.html
	& \texttt {\%TAB\%}
	& tableau éditable des paramètres de l'application
	\\ \hline
    admrefliste.html
	& \texttt {\%TABLEAU\%}
	& tableau des paramètres éditables
	\\ \cline {2-3}
	& \texttt {\%TITREPAGE\%}
	& titre de la page contenant le type d'objet en cours de modification
	\\ \cline {2-3}
	& \texttt {\%TYPE\%}
	& type d'objet en cours de modification
	\\ \hline
    admreledit.html
	& \texttt {\%DOMAINE\%}
	& domaine sélectionné
	\\ \cline {2-3}
	& \texttt {\%TABLEAU\%}
	& tableau éditable des relais de messagerie pour ce domaine
	\\ \hline
    admrelmodif.html
	& \texttt {\%DOMAINE\%}
	& domaine sélectionné
	\\ \cline {2-3}
	& \texttt {\%TABLEAU\%}
	& relais de messagerie enregistrés pour ce domaine
	\\ \hline
    admrelsel.html
	& \texttt {\%DOMAINE\%}
	& menu de sélection du domaine
	\\ \hline
    admvalide.html
	& \texttt {\%TYPEENCLAIR\%}
	& type de l'objet modifié
	\\ \cline {2-3}
	& \texttt {\%URL\%}
	& lien vers le script de modification du type d'objet modifié
	\\ \hline
    ajout.html
	\cbstart%1.5
	& \texttt {\%ADR\%}
	& adresse IP à ajouter
	\\ \cline {2-3}
	& \texttt {\%DHCPPROFILLIBELLE\%}
	& libellé du menu de sélection de profil DHCP, ou vide
	\\ \cline {2-3}
	& \texttt {\%DHCPPROFILMENU\%}
	& menu de sélection de profil DHCP (ou champ caché)
	\\ \cline {2-3}
	& \texttt {\%DISPLAY\%}
	& valeur d'attribut CSS pour afficher (\texttt {block}) ou
	    non (\texttt {none}) les parties «~recherche de plusieurs
	    adresses~» et «~ajout d'un alias~», comme par exemple
	    lors de l'ajout de plusieurs adresses consécutives
	\\ \cline {2-3}
	& \texttt {\%DOMAINE\%}
	& menu de présentation des domaines
	\\ \cline {2-3}
	& \texttt {\%DOMAINEREF\%}
	& menu de présentation des domaines, pour l'ajout d'alias
	\\ \cline {2-3}
	& \texttt {\%DROITSMTPLIBELLE\%}
	& libellé de la case à cocher d'émission en SMTP, ou vide
	\\ \cline {2-3}
	& \texttt {\%DROITSMTPMENU\%}
	& code HTML pour la case à cocher d'émission en SMTP (ou
	    champ caché)
	\\ \cline {2-3}
	& \texttt {\%MENUHINFO\%}
	& menu des types de machines
	\\ \cline {2-3}
	& \texttt {\%MENUPLAGE\%}
	& menu de sélection d'une plage d'adresses IP pour la
	    recherche d'adresses IPv4 consécutives
	\\ \cline {2-3}
	& \texttt {\%NEXT\%}
	& fragment d'URL pour indiquer l'action qui suivra l'ajout
	    de cette machine (pour revenir à la carte des adresses
	    ou continuer l'ajout de machines successives)
	\\ \cline {2-3}
	& \texttt {\%TTLLIBELLE\%}
	&  libellé de la case d'édition du TTL, ou vide
	\\ \cline {2-3}
	& \texttt {\%TTLVAL\%}
	& code HTML pour la valeur du TTL (ou champ caché)
	\cbend%1.5
	\\ \hline
    consulter.html
	& \texttt {\%CORRESP\%}
	& tableau contenant l'identité du correspondant
	\\ \cline {2-3}
	& \texttt {\%PLAGES\%}
	& liste sélectionnable des réseaux autorisés
	\\ \hline
    consultmx.html
	& \texttt {\%LISTEDOMAINES\%}
	& liste sélectionnable des domaines
	\\ \hline
    consultnet.html
	& \texttt {\%LISTECOMMU\%}
	& liste sélectionnable des communautés
	\\ \cline {2-3}
	& \texttt {\%LISTEETABL\%}
	& liste sélectionnable des établissements
	\\ \cline {2-3}
	& \texttt {\%MENUTRI1\%}
	& menu de sélection du critère de tri primaire
	\\ \cline {2-3}
	& \texttt {\%MENUTRI2\%}
	& menu de sélection du critère de tri secondaire
	\\ \hline
    corresp.html
	& \texttt {\%CRITERE\%}
	& précédent critère de recherche de machine
	\\ \cline {2-3}
	& \texttt {\%RESULTAT\%}
	& résultat d'une précédente recherche d'une machine
	\\ \hline
    dhcpedit.html
	& \texttt {\%IDRESEAU\%}
	& champ caché contenant l'identificateur du réseau en cours d'édition
	\\ \cline {2-3}
	& \texttt {\%RESEAU\%}
	& réseau pour lequel les intervalles DHCP dynamiques sont
	    en cours d'édition
	\\ \cline {2-3}
	& \texttt {\%TABLEAU\%}
	& tableau d'édition des intervalles
	\\ \hline
    dhcpmodif.html
	& \texttt {\%RESEAU\%}
	& réseau pour lequel les intervalles DHCP dynamques ont été modifiés
	\\ \hline
    dhcpsel.html
	& \texttt {\%MENURESEAU\%}
	& menu de sélection du réseau
	\\ \hline
    droits.html
	& \texttt {\%CORRESP\%}
	& tableau contenant l'identité du correspondant
	\\ \cline {2-3}
	& \texttt {\%TABCIDRHORSRESEAU\%}
	& le cas échéant, liste des plages hors des réseaux enregistrés
	\\ \cline {2-3}
	& \texttt {\%TABDHCPPROFIL\%}
	& le cas échéant, récapitulatif des profils DHCP visibles
	\\ \cline {2-3}
	& \texttt {\%TABDOMAINES\%}
	& liste des domaines autorisés
	\\ \cline {2-3}
	& \texttt {\%TABRESEAUX\%}
	& liste des réseaux autorisés en consultation
	\\ \cline {2-3}
	& \texttt {\%TITRECIDRHORSRESEAU\%}
	& le cas échéant, titre de la section des plages hors des
	    réseaux enregistrés
	\\ \hline
    \cbstart%1.5
    edit.html
	& \texttt {\%ADR\%}
	Adresse IP sur laquelle a cliqué l'utilisateur
	& 
	\\ \cline {2-3}
	& \texttt {\%DISPUNEIP\%}
	& valeur d'attribut CSS pour afficher (\texttt {block}) ou
	    non (\texttt {none}) la puce «~supprimer une adresse
	    IP~» selon que la machine a plusieurs adresses IP ou
	    non
	\\ \cline {2-3}
	& \texttt {\%DOMAINE\%}
	& nom du domaine correspondant à l'adresse IP sélectionnée
	\\ \cline {2-3}
	& \texttt {\%MACHINE\%}
	& tableau rappelant l'ensemble des attributs de la machine
	    sélectionnée
	\\ \cline {2-3}
	& \texttt {\%NEXT\%}
	& fragment d'URL pour indiquer l'action qui suivra l'édition
	    de cette machine (pour revenir à la carte des adresses
	    ou à la liste détaillée des machines)
	\\ \cline {2-3}
	& \texttt {\%NEXTARGS\%}
	& arguments de l'action de suite
	\\ \cline {2-3}
	& \texttt {\%NOM\%}
	& nom de machine correspondant à l'adresse IP sélectionnée
	\cbend%1.5
	\\ \hline
    \cbstart%1.5
    editmodif-infos.html
	& \texttt {\%COMMENTAIRE\%}
	& champ de saisie du commentaire
	\\ \cline {2-3}
	& \texttt {\%DHCPPROFILLIBELLE\%}
	& libellé du menu de sélection de profil DHCP, ou vide
	\\ \cline {2-3}
	& \texttt {\%DHCPPROFILMENU\%}
	& menu de sélection de profil DHCP (ou champ caché)
	\\ \cline {2-3}
	& \texttt {\%DOMAINE\%}
	& nouveau domaine du RR en cours de modification
	\\ \cline {2-3}
	& \texttt {\%DROITSMTPLIBELLE\%}
	& libellé de la case à cocher d'émission en SMTP, ou vide
	\\ \cline {2-3}
	& \texttt {\%DROITSMTPMENU\%}
	& code HTML pour la case à cocher d'émission en SMTP (ou
	    champ caché)
	\\ \cline {2-3}
	& \texttt {\%IDRR\%}
	& champ caché : référence interne de la machine
	    en cours d'édition
	\\ \cline {2-3}
	& \texttt {\%MAC\%}
	& champ de saisie de l'adresse MAC
	\\ \cline {2-3}
	& \texttt {\%MENUHINFO\%}
	& menu des types de machines
	\\ \cline {2-3}
	& \texttt {\%NEXTARGS\%}
	& arguments de l'action de suite
	\\ \cline {2-3}
	& \texttt {\%NEXTPROG\%}
	& action de suite
	\\ \cline {2-3}
	& \texttt {\%NOM\%}
	& nouveau nom du RR en cours de modification
	\\ \cline {2-3}
	& \texttt {\%RESPMEL\%}
	& champ de saisie de l'adresse électronique du responsable de la
	    machine
	\\ \cline {2-3}
	& \texttt {\%RESPNOM\%}
	& champ de saisie du nom du responsable de la machine
	\\ \cline {2-3}
	& \texttt {\%TTLLIBELLE\%}
	&  libellé de la case d'édition du TTL, ou vide
	\\ \cline {2-3}
	& \texttt {\%TTLVAL\%}
	& code HTML pour la valeur du TTL (ou champ caché)
	\\ \cline {2-3}
	& \texttt {\%VDOMAINE\%}
	& nom original de domaine de la machine en cours d'édition
	\\ \cline {2-3}
	& \texttt {\%VNOM\%}
	& nom original de la machine en cours d'édition
	\cbend%1.5
	\\ \hline
    erreur.html
	& \texttt {\%MESSAGE\%}
	& message d'erreur
	\\ \hline
    \cbstart%.15
    liste.html
	& \texttt {\%DATE\%}
	& date de l'extraction
	\\ \cline {2-3}
	& \texttt {\%TABLEAU\%}
	& liste des machines trouvées
	\\ \cline {2-3}
	& \texttt {\%TITRE\%}
	& titre de la page
	\\ \hline
    liste.tex
	& \texttt {\%DATE\%}
	& date de l'extraction
	\\ \cline {2-3}
	& \texttt {\%NBMACHINES\%}
	& nombre d'adresses déclarées
	\\ \cline {2-3}
	& \texttt {\%ORIENTATION\%}
	& \texttt {portrait} ou \texttt {landscape}
	\\ \cline {2-3}
	& \texttt {\%TABLEAU\%}
	& liste des machines trouvées
	\cbend%1.5
	\\ \hline
    listecorresp.html
	& \texttt {\%LISTECOR\%}
	& liste des correspondants trouvés
	\\ \cline {2-3}
	& \texttt {\%TITREPAGE\%}
	& titre de la page
	\\ \hline
    listedes.html
	& \texttt {\%DATE\%}
	& date de l'extraction
	\\ \cline {2-3}
    et
	& \texttt {\%ORIENTATION\%}
	& \texttt {portrait} ou \texttt {landscape} (pour liste.tex
	    uniquement)
	\\ \cline {2-3}
    listedes.tex
	& \texttt {\%TABLEAU\%}
	& liste extraite
	\\ \cline {2-3}
	& \texttt {\%TITRE\%}
	& type d'objet dont on a la liste
	\\ \cline {2-3}
	& \texttt {\%TXT\%}
	& texte d'explication sur les paramètres de l'extraction
	\\ \hline
    mail.html
	& \texttt {\%DOMAINE\%}
	& menu de sélection d'un domaine
	\\ \hline
    mailheberg-edit.html
	& \texttt {\%DOMAINE\%}
	& domaine de l'adresse de messagerie en cours d'édition
	\\ \cline {2-3}
	& \texttt {\%DOMAINEH\%}
	& menu pour modifier l'hébergeur trouvé
	\\ \cline {2-3}
	& \texttt {\%NOM\%}
	& nom de l'adresse de messagerie en cours d'édition
	\\ \cline {2-3}
	& \texttt {\%NOMH\%}
	& nom éditable de l'hébergeur trouvé
	\\ \hline
    mailheberg-liste.html
	& \texttt {\%DOMAINE\%}
	& domaine dont on demande la liste des adresses de messagerie
	\\ \cline {2-3}
	& \texttt {\%TABLEAU\%}
	& liste des adresses de messagerie, avec les hébergeurs
	\\ \hline
    mailmodif.html
	& \texttt {\%ACTION\%}
	& type d'action (ajout, modification, suppression) effectuée
	\\ \cline {2-3}
	& \texttt {\%NOM\%}
	& nom (complet) de l'adresse de messagerie modifiée
	\\ \hline
    modif.html
	& \texttt {\%DOMAINE\%}
	& menu de sélection de domaine
	\\ \hline
    statcor.html
	& \texttt {\%NBRRCOR\%}
	& tableau contenant le nombre de RR modifiés par correspondant
	\\ \hline
    statetab.html
	& \texttt {\%NBMACHETABL\%}
	& nombre de machines et d'adresses par établissement
	\\ \hline
    suppr.html
	& \texttt {\%DOMAINE\%}
	& menu de sélection de domaine
	\\ \hline
    traiteajout-alias.html
	& \texttt {\%DOCDNS\%}
	& adresse d'une page publique (hors de l'application)
	    décrivant la documentation de votre service DNS.
	\\ \cline {2-3}
	& \texttt {\%DOMAINE\%}
	& domaine de l'alias
	\\ \cline {2-3}
	& \texttt {\%DOMAINEREF\%}
	& domaine de la machine
	\\ \cline {2-3}
	& \texttt {\%INTERVALLE\%}
	& intervalle entre deux générations de zones sur le serveur
	    DNS.
	\\ \cline {2-3}
	& \texttt {\%NOM\%}
	& nom de l'alias
	\\ \cline {2-3}
	& \texttt {\%NOMREF\%}
	& nom de la machine
	\\ \hline
    \cbstart%1.5
    traiteajout-existe.html
	& \texttt {\%ADR\%}
	& nouvelle adresse à ajouter
	\\ \cline {2-3}
	& \texttt {\%DOMAINE\%}
	& nom du domaine de la machine existante
	\\ \cline {2-3}
	& \texttt {\%HIDDEN\%}
	& champs cachés véhiculant la requête d'ajout
	\\ \cline {2-3}
	& \texttt {\%MACHINE\%}
	& tableau récapitulant toutes les informations
	    sur la machine en cours d'ajout
	\\ \cline {2-3}
	& \texttt {\%NOM\%}
	& nom de la machine existante
	\\ \hline
    traiteajout-machine.html
	& \texttt {\%DOCDNS\%}
	& adresse d'une page publique (hors de l'application)
	    décrivant la documentation de votre service DNS.
	\\ \cline {2-3}
	& \texttt {\%INTERVALLE\%}
	& intervalle entre deux générations de zones sur le serveur
	    DNS.
	\\ \cline {2-3}
	& \texttt {\%MACHINE\%}
	& tableau récapitulant toutes les informations
	    sur la machine en cours d'ajout
	\\ \cline {2-3}
	& \texttt {\%SUITE\%}
	& URL de l'action de continuation
	\\ \hline
    traiteajout-multi.html
	& \texttt {\%LISTE\%}
	& tableau donnant les blocs d'adresses IPv4 consécutives
	\\ \hline
    traiteajout-smtp.html
	& \texttt {\%HIDDEN\%}
	& champs cachés véhiculant la requête d'ajout
	\cbend%.15
	\\ \hline
    traitemodif-infos.html
	& \texttt {\%COMMENTAIRE\%}
	& commentaire sur la machine modifiée
	\\ \cline {2-3}
	& \texttt {\%DHCPPROFIL\%}
	& profil DHCP de la machine modifiée
	\\ \cline {2-3}
	& \texttt {\%DOCDNS\%}
	& adresse d'une page publique (hors de l'application)
	    décrivant la documentation de votre service DNS.
	\\ \cline {2-3}
	& \texttt {\%DOMAINE\%}
	& domaine de la machine modifiée
	\\ \cline {2-3}
	& \texttt {\%HINFO\%}
	& type de la machine modifiée
	\\ \cline {2-3}
	& \texttt {\%INTERVALLE\%}
	& intervalle entre deux générations de zones sur le serveur
	    DNS.
	\\ \cline {2-3}
	& \texttt {\%MAC\%}
	& adresse MAC de la machine modifiée
	\\ \cline {2-3}
	& \texttt {\%NOM\%}
	& nom de la machine modifiée
	\\ \cline {2-3}
	& \texttt {\%RESPMEL\%}
	& adresse électronique du responsable de la machine modifiée
	\\ \cline {2-3}
	& \texttt {\%RESPNOM\%}
	& nom du responsable de la machine modifiée
	\\ \cline {2-3}
	\cbstart%1.5
	& \texttt {\%SUITE\%}
	& URL de l'action de continuation
	\\ \cline {2-3}
	& \texttt {\%TTL\%}
	& valeur de TTL de la machine modifiée
	\cbend%1.5
	\\ \hline
    \cbstart%1.5
    traitemodif-smtp.html
	& \texttt {\%HIDDEN\%}
	& champs cachés véhiculant la requête de modification
	\cbend%.15
	\\ \hline
    traitesuppr-alias.html
	& \texttt {\%DOMAINE\%}
	& domaine de l'alias à supprimer
	\\ \cline {2-3}
	& \texttt {\%DOMAINEREF\%}
	& domaine de la machine
	\\ \cline {2-3}
	\cbstart%1.5
	& \texttt {\%NEXTARGS\%}
	& arguments de l'action de suite
	\\ \cline {2-3}
	& \texttt {\%NEXTPROG\%}
	& action de suite
	\cbend%1.5
	\\ \cline {2-3}
	& \texttt {\%NOM\%}
	& nom de l'alias à supprimer
	\\ \cline {2-3}
	& \texttt {\%NOMREF\%}
	& nom de la machine
	\\ \hline
    \cbstart%1.5
    traitesuppr-ip-objet.html
	& \texttt {\%ADR\%}
	& adresse dont la suppression est demandée
	\\ \cline {2-3}
    et
	& \texttt {\%MACHINE\%}
	& tableau récapitulant toutes les informations
	    sur la machine en cours de suppression
	\\ \cline {2-3}
    traitesuppr-ip-uneip.html
	& \texttt {\%NEXTARGS\%}
	& arguments de l'action de suite
	\\ \cline {2-3}
	& \texttt {\%NEXTPROG\%}
	& action de suite
	\\ \hline
    traitesuppr-nom.html
	& \texttt {\%DOMAINE\%}
	& domaine correspondant à la suppression demandée
	\\ \cline {2-3}
	& \texttt {\%MACHINE\%}
	& tableau récapitulant toutes les informations
	    sur la machine en cours de suppression
	\\ \cline {2-3}
	& \texttt {\%NEXTARGS\%}
	& arguments de l'action de suite
	\\ \cline {2-3}
	& \texttt {\%NEXTPROG\%}
	& action de suite
	\\ \cline {2-3}
	& \texttt {\%NOM\%}
	& nom dont la suppression est demandée
	\cbend%1.5
	\\ \hline
    traitesuppr-ok.html
	& \texttt {\%DOCDNS\%}
	& adresse d'une page publique (hors de l'application)
	    décrivant la documentation de votre service DNS.
	\\ \cline {2-3}
	& \texttt {\%INTERVALLE\%}
	& intervalle entre deux générations de zones sur le serveur
	    DNS.
	\\ \cline {2-3}
	& \texttt {\%OBJET\%}
	& type d'objet (adresse IP, nom) supprimé
	\\ \cline {2-3}
	\cbstart%1.5
	& \texttt {\%SUITE\%}
	& URL de l'action de continuation
	\cbend%1.5
	\\ \hline
\end {supertabular}
}

\clearpage
\titreB {Pages à trous de WebAuth}

{\small
    \tablehead {\hline
	\multicolumn {1} {|c|} {\textbf {Fichier}} &
		\multicolumn {1} {|c|} {\textbf {Trou}} &
		\multicolumn {1} {|c|} {\textbf {Signification}}
	\\ \hline
    }
    \tabletail {\hline}
\begin {supertabular} {|l|l|p{100mm}|}
    (tous)
	& \texttt {\%HOMEURL\%}
	& adresse relative de la page d'accueil par rapport
	    à la racine du serveur Web
	\\ \hline
    actionok.html
	& \texttt {\%COMPLEMENT\%}
	& texte apportant un complément d'information le cas échéant.
	\\ \cline {2-3}
	& \texttt {\%TITREACTION\%}
	& titre de l'action effectuée
	\\ \hline
    admparliste.html
	& \texttt {\%TAB\%}
	& tableau contenant les paramètres éditables de l'application
	\\ \hline
    erreur.html
	& \texttt {\%MESSAGE\%}
	& message d'erreur
	\\ \hline
    grpajout.html
	& \texttt {\%GROUPES\%}
	& liste des groupes existant dans la base
	\\ \hline
    grpconsult.html
	& \texttt {\%GROUPES\%}
	& liste des groupes existant dans la base
	\\ \hline
    grpmodif.html
	& \texttt {\%MENUGROUPE\%}
	& menu HTML permettant de sélectionner le groupe à modifier
	\\ \hline
    grpsuppr.html
	& \texttt {\%MENUGROUPE\%}
	& menu HTML permettant de sélectionner le groupe à modifier
	\\ \hline
    grptraitemodif.html
	& \texttt {\%DESCR\%}
	& description du groupe en cours de modification
	\\ \cline {2-3}
	& \texttt {\%GROUPE\%}
	& groupe en cours de modification
	\\ \cline {2-3}
	& \texttt {\%LISTEMEMBRES\%}
	& liste HTML des utilisateurs membres du le groupe
	\\ \cline {2-3}
	& \texttt {\%LISTETOUS\%}
	& liste HTML des utilisateurs hors du groupe dans le groupe
	\\ \cline {2-3}
	& \texttt {\%VRAISMEMBRES\%}
	& liste actuelle des membres du groupe en cours de modication
	\\ \hline
    pwdchoix.html
	& (aucun)
	& (aucun)
	\\ \hline
    pwderr.html
	& \texttt {\%MESSAGE\%}
	& message d'erreur
	\\ \hline
    pwdok.html
	& (aucun)
	& (aucun)
	\\ \hline
    utiajoutinit.htgt
	& \texttt {\%URL\%}
	& URL du script \texttt {uti}
	\\ \hline
    utichoix.html
	& \texttt {\%AUCUN\%}
	& formulaire de re-sélection si aucun utilisateur n'a été trouvé
	\\ \cline {2-3}
	& \texttt {\%LISTEUTILISATEURS\%}
	& liste des utilisateurs trouvés
	\\ \cline {2-3}
	& \texttt {\%MESSAGE\%}
	& message affiché au cas où plusieurs utilisateurs ont été trouvés
	\\ \hline
    utiliste.html
	& \texttt {\%DATE\%}
	& date
	\\ \cline {2-3}
    et
	& \texttt {\%HEURE\%}
	& heure
	\\ \cline {2-3}
    utiliste.tex
	& \texttt {\%NBUTILISATEURS\%}
	& nombre d'utilisateurs trouvés
	\\ \cline {2-3}
	& \texttt {\%S\%}
	& <<~s~>> si plusieurs utilisateurs ont été trouvés
	\\ \cline {2-3}
	& \texttt {\%TABLEAU\%}
	& tableau HTML présentant la liste des utilisateurs
	\\ \hline
    utimenu.htgt
	& \texttt {\%URL\%}
	& URL du script \texttt {uti}
	\\ \hline
    utimodif.html
	& \texttt {\%ACTION\%}
	& action à effectuer à la suite de la modification des paramètres
	\\ \cline {2-3}
	& \texttt {\%ETAT\%}
	& état 
	\\ \cline {2-3}
	& \texttt {\%PARAMUTILISATEUR\%}
	& formulaire d'édition des paramètres de l'utilisateur
	\\ \cline {2-3}
	& \texttt {\%TITRE\%}
	& nom de l'action qui va être effectuée
	\\ \cline {2-3}
	& \texttt {\%URL\%}
	& URL du script \texttt {uti}
	\\ \hline
    utipasswd.html
	& \texttt {\%LOGIN\%}
	& nom de login de l'utilisateur
	\\ \cline {2-3}
	& \texttt {\%NOM\%}
	& nom de l'utilisateur
	\\ \cline {2-3}
	& \texttt {\%PRENOM\%}
	& prénom de l'utilisateur
	\\ \cline {2-3}
	& \texttt {\%URL\%}
	& URL du script \texttt {uti}
	\\ \hline
    utisel.html
	& \texttt {\%ACTION\%}
	& action à effectuer après la sélection
	\\ \cline {2-3}
	& \texttt {\%CRITERES\%}
	& formulaire de saisie des critères de sélection
	\\ \cline {2-3}
	& \texttt {\%MESSAGE\%}
	& message préalable aux critères de sélection
	\\ \cline {2-3}
	& \texttt {\%URL\%}
	& URL du script \texttt {uti}
	\\ \hline
    utisuppr.html
	& \texttt {\%LOGIN\%}
	& nom de login de l'utilisateur
	\\ \cline {2-3}
	& \texttt {\%URL\%}
	& URL du script \texttt {uti}
	\\ \cline {2-3}
	& \texttt {\%UTILISATEUR\%}
	& login de l'utilisateur à supprimer
	\\ \hline
\end {supertabular}
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%}}
% Annexe - Licence
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\clearpage
\cbstart%1.5
\titreA {Licence}
    \label {licence}

\begin {verbatim}
Copyright Université de Strasbourg
Contributeurs : Pierre David (pda@unistra.fr) & Jean Benoit (jean@unistra.fr)

Ce logiciel est régi par la licence CeCILL-B soumise au droit français et
respectant les principes de diffusion des logiciels libres. Vous pouvez
utiliser, modifier et/ou redistribuer ce programme sous les conditions
de la licence CeCILL-B telle que diffusée par le CEA, le CNRS et l'INRIA 
sur le site "http://www.cecill.info".

En contrepartie de l'accessibilité au code source et des droits de copie,
de modification et de redistribution accordés par cette licence, il n'est
offert aux utilisateurs qu'une garantie limitée.  Pour les mêmes raisons,
seule une responsabilité restreinte pèse sur l'auteur du programme,  le
titulaire des droits patrimoniaux et les concédants successifs.

A cet égard  l'attention de l'utilisateur est attirée sur les risques
associés au chargement,  à l'utilisation,  à la modification et/ou au
développement et à la reproduction du logiciel par l'utilisateur étant 
donné sa spécificité de logiciel libre, qui peut le rendre complexe à 
manipuler et qui le réserve donc à des développeurs et des professionnels
avertis possédant  des  connaissances  informatiques approfondies.  Les
utilisateurs sont donc invités à charger  et  tester  l'adéquation  du
logiciel à leurs besoins dans des conditions permettant d'assurer la
sécurité de leurs systèmes et ou de leurs données et, plus généralement, 
à l'utiliser et l'exploiter dans les mêmes conditions de sécurité. 

Le fait que vous puissiez accéder à cet en-tête signifie que vous avez 
pris connaissance de la licence CeCILL-B, et que vous en avez accepté les
termes.
------------------------------------------------------------------------------
Copyright Université de Strasbourg
Contributors : Pierre David (pda@unistra.fr) & Jean Benoit (jean@unistra.fr)

This software is governed by the CeCILL-B license under French law and
abiding by the rules of distribution of free software.  You can  use, 
modify and/ or redistribute the software under the terms of the CeCILL-B
license as circulated by CEA, CNRS and INRIA at the following URL
"http://www.cecill.info". 

As a counterpart to the access to the source code and  rights to copy,
modify and redistribute granted by the license, users are provided only
with a limited warranty  and the software's author,  the holder of the
economic rights,  and the successive licensors  have only  limited
liability. 

In this respect, the user's attention is drawn to the risks associated
with loading,  using,  modifying and/or developing or reproducing the
software by the user in light of its specific status of free software,
that may mean  that it is complicated to manipulate,  and  that  also
therefore means  that it is reserved for developers  and  experienced
professionals having in-depth computer knowledge. Users are therefore
encouraged to load and test the software's suitability as regards their
requirements in conditions enabling the security of their systems and/or 
data to be ensured and,  more generally, to use and operate it in the 
same conditions as regards security. 

The fact that you are presently reading this means that you have had
knowledge of the CeCILL-B license and that you accept its terms.
\end{verbatim}
\cbend%1.5

\end {document}
